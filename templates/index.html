<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amar RPG Tools - Web Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 2px;
        }

        .header {
            grid-column: 1 / -1;
            background-color: #1a1a1a;
            padding: 10px;
            border: 2px solid #555;
            text-align: center;
        }

        .title {
            color: #00ffff;
            font-weight: bold;
            font-size: 18px;
        }

        .menu-panel {
            background-color: #000;
            border: 2px solid #555;
            padding: 10px;
            overflow-y: auto;
        }

        .menu-panel.focused {
            border-color: #00ffff;
        }

        .content-panel {
            background-color: #000;
            border: 2px solid #555;
            padding: 5px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .content-panel.focused {
            border-color: #00ffff;
        }

        .status-bar {
            grid-column: 1 / -1;
            background-color: #333;
            padding: 5px 10px;
            border: 1px solid #555;
            font-size: 12px;
            color: #ccc;
        }

        .logo-container {
            position: fixed;
            bottom: 45px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            pointer-events: none;
        }

        .logo-container img {
            max-height: 60px;
            width: auto;
            opacity: 0.7;
        }

        .menu-item {
            padding: 2px 5px;
            cursor: pointer;
            border-radius: 2px;
            margin: 1px 0;
        }

        .menu-item.separator {
            color: #888;
            cursor: default;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
        }

        .menu-item.empty {
            height: 10px;
            cursor: default;
        }

        .menu-item:hover:not(.separator):not(.empty) {
            background-color: #333;
        }

        .menu-item.selected {
            background-color: #444;
            color: #00ffff;
            font-weight: bold;
        }

        .form-container {
            margin: 0;
            padding: 0;
            background-color: transparent;
            border: none;
            width: 100%;
            align-self: stretch;
        }

        .output {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.2;
            width: 100%;
            align-self: stretch;
        }

        .form-group {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label {
            color: #00ffff;
            font-weight: bold;
            min-width: 70px;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin: 4px 0;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 140px;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 6px 8px;
            background-color: #333;
            border: 1px solid #555;
            color: #fff;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
            font-size: 16px;
            height: 36px;
        }

        /* Remove number input spinners */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .btn {
            background-color: #444;
            color: #00ffff;
            border: 1px solid #00ffff;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 3px;
            margin: 0;
        }

        .btn:hover {
            background-color: #555;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .btn:disabled {
            background-color: #222;
            color: #666;
            border-color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }


        .loading {
            color: #ffff00;
            animation: blink 1s infinite;
        }

        .progress-container {
            margin: 20px 0;
            background-color: transparent;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff8800);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: bold;
            font-size: 12px;
            z-index: 1;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .hidden {
            display: none;
        }

        .error {
            color: #ff4444;
            background-color: #330000;
            padding: 10px;
            border: 1px solid #ff4444;
            border-radius: 3px;
            margin: 10px 0;
        }

        .success {
            color: #44ff44;
            background-color: #003300;
            padding: 10px;
            border: 1px solid #44ff44;
            border-radius: 3px;
            margin: 10px 0;
        }

        .edit-container {
            margin: 10px 0;
            padding: 0;
        }

        .edit-textarea {
            width: 100%;
            min-height: 400px;
            background-color: #000;
            color: #fff;
            border: 1px solid #555;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.2;
            resize: vertical;
            white-space: pre;
        }

        .edit-buttons {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }

        .edit-btn {
            background-color: #444;
            color: #00ffff;
            border: 1px solid #00ffff;
            padding: 6px 12px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 3px;
            font-size: 12px;
        }

        .edit-btn:hover {
            background-color: #555;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        /* Color classes for TUI output */
        .fg-14 { color: #00ffff; }  /* bright cyan */
        .fg-229 { color: #ffffaf; } /* light yellow */
        .fg-15 { color: #ffffff; }  /* bright white */
        .fg-13 { color: #ff00ff; }  /* bright magenta */
        .fg-7 { color: #c0c0c0; }   /* white */
        .fg-10 { color: #00ff00; }  /* bright green */
        .fg-202 { color: #ff5f00; } /* red-orange */
        .bold { font-weight: bold; }

        /* Modern Theme Styles - Fantasy RPG inspired */
        .modern-theme {
            background: linear-gradient(135deg, #4a5d3a 0%, #6b8e5a 100%);
            color: #2c3e50;
            font-family: Georgia, serif;
            min-height: 100vh;
        }

        .modern-theme .container {
            background: #f4f1e8;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            flex-direction: column !important;
            min-height: 100vh;
            display: flex !important;
            padding-bottom: 50px; /* Space for status bar */
        }

        .modern-theme .header {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: #f4f1e8;
            padding: 20px 30px;
            border-bottom: 3px solid #654321;
        }

        .modern-theme .title {
            font-family: Georgia, serif;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: #f4f1e8 !important;
        }

        /* Horizontal menu layout - full width across top */
        .modern-theme .menu-panel {
            display: flex;
            flex-wrap: wrap;
            background: linear-gradient(135deg, #2d5016 0%, #3a6b1c 100%);
            border: none;
            border-radius: 0;
            padding: 0;
            margin: 0;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
            z-index: 10;
        }

        .modern-theme .menu-item {
            color: #e8f5e8;
            padding: 8px 15px;
            border-radius: 0;
            margin: 0;
            border-right: 1px solid #1a3009;
            transition: all 0.3s ease;
            cursor: pointer;
            flex: 1;
            text-align: center;
            min-width: 120px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            font-size: 12px;
        }

        .modern-theme .menu-item:hover {
            background: #228b22;
            color: white;
            transform: none;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .modern-theme .menu-item.selected {
            background: #8b4513;
            color: #f4f1e8;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.4);
        }

        .modern-theme .menu-item.separator {
            display: none;
        }

        /* Content panel - full width below menu with proper spacing */
        .modern-theme .content-panel {
            background: #fefbf3;
            border: 2px solid #d2b48c;
            border-radius: 8px;
            margin: 15px auto;
            padding: 20px;
            padding-bottom: 20px;
            min-height: 400px;
            font-family: Georgia, serif;
            width: calc(100% - 30px);
            max-width: 1140px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            overflow: auto;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .modern-theme .form-container {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 20px 0;
            margin: 15px 0;
            box-shadow: none;
        }

        .modern-theme .btn {
            background: linear-gradient(135deg, #228b22 0%, #32cd32 100%);
            color: white;
            border: 2px solid #1e7b1e;
            border-radius: 8px;
            padding: 12px 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(34, 139, 34, 0.3);
            font-family: Georgia, serif;
        }

        .modern-theme .btn:hover {
            background: linear-gradient(135deg, #1e7b1e 0%, #228b22 100%);
            transform: translateY(-1px);
            box-shadow: 0 5px 12px rgba(34, 139, 34, 0.4);
        }

        .modern-theme .status-bar {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%) !important;
            color: #f4f1e8 !important;
            border-radius: 0 0 0 0;
            padding: 12px 30px;
            font-weight: bold;
            font-family: Georgia, serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            position: fixed !important;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            border-top: 3px solid #654321;
            width: 100%;
            max-width: 1200px;
            display: block !important;
            visibility: visible !important;
        }

        .modern-theme .status-bar a {
            color: #f4f1e8 !important;
            text-decoration: underline;
        }

        .modern-theme .container {
            background: #f4f1e8;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            flex-direction: column !important;
            min-height: 100vh;
            display: flex !important;
            padding-bottom: 50px; /* Space for status bar */
        }

        .modern-theme .output {
            background: #fefbf3;
            padding: 15px;
            border: 2px solid #d2b48c;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
            max-width: 100%;
        }

        .modern-theme #themeToggle {
            background: #228b22;
            color: white !important;
            border: 2px solid #1e7b1e;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: bold;
            font-family: Georgia, serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            opacity: 1 !important;
        }

        .modern-theme #themeToggle:hover {
            background: #1e7b1e;
            transform: scale(1.02);
            color: white !important;
        }

        /* Fix ALL readability issues in modern theme - much darker colors */
        .modern-theme .output .fg-14 { color: #4a2c2a !important; } /* very dark brown instead of cyan */
        .modern-theme .output .fg-46 { color: #2d5016 !important; } /* forest green with good contrast */
        .modern-theme .output .fg-226 { color: #4b3619 !important; } /* very dark brown for 4 in O6 */
        .modern-theme .output .fg-202 { color: #8b4513 !important; } /* brown instead of orange */
        .modern-theme .output .fg-7 { color: #333333 !important; } /* darker gray instead of light gray */
        .modern-theme .output .fg-13 { color: #4a2c2a !important; } /* very dark brown instead of magenta */
        .modern-theme .output .fg-229 { color: #654321 !important; } /* dark brown instead of light yellow */
        .modern-theme .output .fg-15 { color: #2c3e50 !important; } /* dark instead of white */
        .modern-theme .output .fg-10 { color: #2d5016 !important; } /* forest green with good contrast */
        .modern-theme .output .fg-88 { color: #8b0000 !important; } /* dark red for fumbles */
        .modern-theme .output .fg-124 { color: #8b2500 !important; } /* dark orange-red for -3 in O6 */
        .modern-theme .output .fg-154 { color: #3b5323 !important; } /* darker forest green for 5 in O6 */
        .modern-theme .output .fg-118 { color: #2d5016 !important; } /* dark green for 6 in O6 */
        .modern-theme .output .fg-82 { color: #2d5016 !important; } /* dark forest green */
        .modern-theme .output .fg-196 { color: #8b0000 !important; } /* dark red */

        /* O6 Dice Roll Colors - Full gradient from red to green with STRONG contrast */
        .modern-theme .output .fg-160 { color: #8b0000 !important; } /* dark red for -2 */
        .modern-theme .output .fg-166 { color: #8b2500 !important; } /* dark orange-red for -1 */
        .modern-theme .output .fg-172 { color: #8b4513 !important; } /* saddle brown for 0 */
        .modern-theme .output .fg-178 { color: #6b4423 !important; } /* dark brown for 1 */
        .modern-theme .output .fg-184 { color: #5b4033 !important; } /* darker brown for 2 */
        .modern-theme .output .fg-190 { color: #4b3619 !important; } /* very dark goldenrod for 3 */
        .modern-theme .output .fg-40 { color: #228b22 !important; } /* forest green for 9 */
        .modern-theme .output .fg-34 { color: #006400 !important; } /* dark green for 10-11 */
        .modern-theme .output .fg-28 { color: #004d00 !important; } /* darker green for 12-14 */
        .modern-theme .output .fg-22 { color: #003300 !important; } /* very dark green for 15+ */

        /* Fix inline style colors - override hardcoded colors from Python */
        /* Cyan text - make it all dark brown */
        .modern-theme .output span[style*="color: #00ffff"] { color: #4a2c2a !important; font-weight: bold !important; } /* cyan to dark brown */
        .modern-theme span[style*="color: #00ffff"] { color: #4a2c2a !important; font-weight: bold !important; } /* cyan everywhere */
        .modern-theme [style*="color: #00ffff"] { color: #4a2c2a !important; } /* cyan in any element */

        /* O6 Dice gradient colors - from red through brown to green - ALL BOLD */
        .modern-theme .output span[style*="color: #870000"] { color: #8b0000 !important; font-weight: bold !important; } /* -3 and worse: dark red */
        .modern-theme .output span[style*="color: #af0000"] { color: #8b0000 !important; font-weight: bold !important; } /* -3: dark red */
        .modern-theme .output span[style*="color: #d70000"] { color: #a52a2a !important; font-weight: bold !important; } /* -2: brown-red */
        .modern-theme .output span[style*="color: #d75f00"] { color: #8b4513 !important; font-weight: bold !important; } /* -1: saddle brown */
        .modern-theme .output span[style*="color: #d78700"] { color: #a0522d !important; font-weight: bold !important; } /* 0: sienna */
        .modern-theme .output span[style*="color: #d7af00"] { color: #8b6914 !important; font-weight: bold !important; } /* 1: dark goldenrod */
        .modern-theme .output span[style*="color: #d7d700"] { color: #b8860b !important; font-weight: bold !important; } /* 2: darker goldenrod */
        .modern-theme .output span[style*="color: #d7ff00"] { color: #daa520 !important; font-weight: bold !important; } /* 3: goldenrod */
        .modern-theme .output span[style*="color: #ffff00"] { color: #cd853f !important; font-weight: bold !important; } /* 4: peru */
        .modern-theme .output span[style*="color: #afff00"] { color: #556b2f !important; font-weight: bold !important; } /* 5: dark olive green */
        .modern-theme .output span[style*="color: #87ff00"] { color: #228b22 !important; font-weight: bold !important; } /* 6: forest green */
        .modern-theme .output span[style*="color: #5fff00"] { color: #228b22 !important; font-weight: bold !important; } /* 7: forest green */
        .modern-theme .output span[style*="color: #00ff00"] { color: #228b22 !important; font-weight: bold !important; } /* 8: bright green, help text */
        .modern-theme .output span[style*="color: #00d700"] { color: #228b22 !important; font-weight: bold !important; } /* 9: forest green */
        .modern-theme .output span[style*="color: #00af00"] { color: #006400 !important; font-weight: bold !important; } /* 10-11: dark green */
        .modern-theme .output span[style*="color: #008700"] { color: #004d00 !important; font-weight: bold !important; } /* 12+: darker green */

        /* Town output colors - improved contrast and differentiation */
        .modern-theme .output span[style*="color: #ff5f00"] { color: #8b4513 !important; font-weight: bold !important; } /* orange to saddle brown - names */
        .modern-theme .output span[style*="color: #ff8700"] { color: #a0522d !important; } /* orange to sienna */
        .modern-theme .output span[style*="color: #ffaf00"] { color: #8b6914 !important; } /* gold to dark goldenrod */
        .modern-theme .output span[style*="color: #ff0000"] { color: #8b0000 !important; } /* bright red to dark red */
        .modern-theme .output span[style*="color: #d7ffff"] { color: #4682b4 !important; } /* light cyan to steel blue */
        .modern-theme .output span[style*="color: #87afff"] { color: #4682b4 !important; } /* light blue to steel blue */
        .modern-theme .output span[style*="color: #808080"] { color: #696969 !important; } /* gray to dim gray for less important text */
        .modern-theme .output span[style*="color: #c0c0c0"] { color: #2c3e50 !important; } /* light gray to dark for main text */

        /* Other colors */
        .modern-theme .output span[style*="color: #008080"] { color: #2d5016 !important; } /* teal to dark green */
        .modern-theme [style*="color: #ffffff"] { color: #2c3e50 !important; } /* white to dark */
        .modern-theme [style*="color: #ffff00"] { color: #8b4513 !important; } /* yellow to brown */
        .modern-theme [style*="color: #ff00ff"] { color: #654321 !important; } /* magenta to brown */

        /* Fix form label colors */
        .modern-theme h3 { color: #654321 !important; } /* dark brown form titles */
        .modern-theme label { color: #4a4a4a !important; } /* readable gray labels */

        /* Fix loading/blinking text */
        .modern-theme .loading {
            color: #8b4513 !important;
        }

        /* Fix additional color issues */
        .modern-theme [style*="color: #008000"] { color: #2d5016 !important; } /* green to dark green */
        .modern-theme [style*="color: #ffffaf"] { color: #8b4513 !important; } /* light yellow to brown */
        .modern-theme [style*="color: #c0c0c0"] { color: #4a4a4a !important; } /* light gray to dark gray */
        .modern-theme span[style*="font-weight: bold"][style*="color: #ffffff"] { color: #2c3e50 !important; } /* bold white to dark */

        /* Remove outer output frame in modern theme */
        .modern-theme .output {
            background: transparent;
            padding: 10px 0;
            border: none;
            border-radius: 0;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            box-shadow: none;
            overflow-x: auto;
            max-width: 100%;
        }

        /* Fix button colors in modern theme - simple flat style */
        .modern-theme .edit-btn,
        .modern-theme .btn {
            background: #228b22 !important;
            color: white !important;
            border: 1px solid #1e7b1e !important;
            border-radius: 4px !important;
            padding: 8px 16px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            font-weight: normal !important;
            font-size: 13px !important;
        }

        .modern-theme .edit-btn:hover,
        .modern-theme .btn:hover {
            background: #1e7b1e !important;
        }

        /* Welcome image alignment */
        .modern-theme #welcomeImage {
            text-align: center;
        }

        body:not(.modern-theme) #welcomeImage {
            text-align: left;
        }

        /* Hamburger Menu for Mobile */
        .hamburger-menu {
            display: none;
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 1001;
            background: #333;
            border: 2px solid #555;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 20px;
            color: #00ffff;
            border-radius: 5px;
        }

        .mobile-menu-dropdown {
            display: none;
            position: fixed;
            top: 105px;
            left: 10px;
            background: #1a1a1a;
            border: 2px solid #555;
            border-radius: 5px;
            max-width: 300px;
            width: calc(100% - 20px);
            max-height: 70vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }

        .mobile-menu-dropdown.active {
            display: block;
        }

        .mobile-menu-dropdown .menu-item {
            display: block;
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.2s;
        }

        .mobile-menu-dropdown .menu-item:hover {
            background: #2a2a2a;
        }

        .mobile-menu-dropdown .menu-item:last-child {
            border-bottom: none;
        }

        /* Modern theme dropdown */
        .modern-theme .mobile-menu-dropdown {
            background: linear-gradient(135deg, #2d5016 0%, #3a6b1c 100%);
            border-color: #4a7c2c;
        }

        .modern-theme .mobile-menu-dropdown .menu-item {
            border-bottom-color: rgba(255,255,255,0.1);
        }

        .modern-theme .mobile-menu-dropdown .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }

            /* Hide regular menu panel on mobile */
            .menu-panel {
                display: none !important;
            }

            /* Show hamburger menu on mobile */
            .hamburger-menu {
                display: block;
            }

            .content-panel {
                padding: 80px 10px 10px 10px; /* Add top padding to prevent hamburger overlap */
            }

            .header {
                padding: 8px;
            }

            .title {
                font-size: 14px;
            }

            #themeToggle {
                padding: 5px 10px !important;
                font-size: 11px !important;
            }

            .menu-item {
                padding: 8px;
                font-size: 12px;
            }

            .output {
                font-size: 11px;
                line-height: 1.4;
            }

            .form-container {
                padding: 10px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .form-group {
                width: 100%;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100% !important;
                max-width: none !important;
            }

            #welcomeImage {
                text-align: center !important;
            }

            #welcomeImage img {
                max-width: 100% !important;
                max-height: 40vh !important;
            }

            .btn, .edit-btn {
                padding: 8px 12px;
                font-size: 11px;
            }

            /* Adjust status bar for mobile */
            .status-bar {
                font-size: 10px;
                padding: 8px;
            }

            /* Stack menu items in groups for better mobile UX */
            .menu-panel {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }

            .menu-item {
                flex: 0 0 calc(50% - 5px);
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .title {
                font-size: 12px;
            }

            .menu-item {
                flex: 0 0 calc(33.333% - 5px);
                padding: 6px;
                font-size: 11px;
            }

            #welcomeImage img {
                max-height: 30vh !important;
            }

            .output {
                font-size: 10px;
            }
        }

        /* Touch-friendly adjustments */
        @media (pointer: coarse) {
            .menu-item {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn, .edit-btn {
                min-height: 44px;
            }

            input, select, textarea {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu for Mobile -->
    <button class="hamburger-menu" id="hamburgerMenu" onclick="toggleMobileMenu()">
        â˜°
    </button>
    <div class="mobile-menu-dropdown" id="mobileMenuDropdown">
        <div class="menu-item" data-action="npc" onclick="handleMobileMenuClick('npc')">Generate NPC</div>
        <div class="menu-item" data-action="encounter" onclick="handleMobileMenuClick('encounter')">Generate Encounter</div>
        <div class="menu-item" data-action="monster" onclick="handleMobileMenuClick('monster')">Generate Monster</div>
        <div class="menu-item" style="color: #42A5A5; font-weight: bold; background: rgba(66,165,165,0.1);">WORLD BUILDING</div>
        <div class="menu-item" data-action="town" onclick="handleMobileMenuClick('town')">Town/City Generator</div>
        <div class="menu-item" data-action="weather" onclick="handleMobileMenuClick('weather')">Weather Generator</div>
        <div class="menu-item" data-action="names" onclick="handleMobileMenuClick('names')">Name Generator</div>
        <div class="menu-item" style="color: #855A85; font-weight: bold; background: rgba(133,90,133,0.1);">UTILITIES</div>
        <div class="menu-item" data-action="roll" onclick="handleMobileMenuClick('roll')">Roll Open Ended d6</div>
        <div class="menu-item" data-action="help" onclick="handleMobileMenuClick('help')">Help</div>
    </div>

    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div class="title"><a href="https://d6gaming.org/" target="_blank" style="color: #00ffff; text-decoration: none;">AMAR RPG</a> TOOLS</div>
                <button id="themeToggle" onclick="toggleTheme()" style="background: #333; color: #00ffff; border: 1px solid #555; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 12px;">
                    <span id="themeToggleText">ðŸŽ¨ Modern UI</span>
                </button>
            </div>
        </div>

        <div class="menu-panel focused" id="menuPanel">
            <div class="menu-item separator" style="color: #2AA52A; text-align: left;">NEW 3-TIER SYSTEM</div>
            <div class="menu-item" data-action="npc">Generate NPC</div>
            <div class="menu-item" data-action="encounter">Generate Encounter</div>
            <div class="menu-item" data-action="monster">Generate Monster</div>
            <div class="menu-item separator" style="color: #42A5A5; text-align: left;">WORLD BUILDING</div>
            <div class="menu-item" data-action="town">Town/City Generator</div>
            <div class="menu-item" data-action="weather">Weather Generator</div>
            <div class="menu-item" data-action="names">Name Generator</div>
            <div class="menu-item separator" style="color: #855A85; text-align: left;">UTILITIES</div>
            <div class="menu-item" data-action="roll">Roll Open Ended d6</div>
            <div class="menu-item" data-action="help">Help</div>
        </div>

        <div class="content-panel" id="contentPanel">
            <div class="output" id="output">Welcome to the <a href="https://d6gaming.org/" target="_blank" style="color: #00ffff;">Amar RPG</a> Tools! Select an option from the menu to get started.

This web interface provides the exact same functionality as the <a href="https://github.com/isene/Amar-Tools" target="_blank" style="color: #00ffff;">terminal version</a>.
<span id="geekUIText">To have a whiff of how the terminal version looks like, try the Geek UI.</span>

<div id="welcomeImage" style="margin-top: 20px;">
    <img src="/static/amar0.jpg" alt="AMAR RPG" style="max-width: 90%; max-height: 60vh; object-fit: contain; opacity: 0.9;">
</div>
            </div>

            <!-- NPC Generation Form -->
            <div class="form-container hidden" id="npcForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 14px;">Generate NPC</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="npcName">Name:</label>
                        <input type="text" id="npcName" placeholder="Random" style="width: 120px;">
                    </div>
                    <div class="form-group">
                        <label for="npcType">Type:</label>
                        <select id="npcType" style="width: 140px;">
                            <option value="">Random</option>
                            <option value="Animal trainer">Animal trainer</option>
                            <option value="Archer">Archer</option>
                            <option value="Armour smith">Armour smith</option>
                            <option value="Army officer">Army officer</option>
                            <option value="Assassin">Assassin</option>
                            <option value="Baker/Cook">Baker/Cook</option>
                            <option value="Bandit">Bandit</option>
                            <option value="Bard">Bard</option>
                            <option value="Boatbuilder">Boatbuilder</option>
                            <option value="Body guard">Body guard</option>
                            <option value="Builder">Builder</option>
                            <option value="Bureaucrat">Bureaucrat</option>
                            <option value="Carpenter">Carpenter</option>
                            <option value="Clergyman">Clergyman</option>
                            <option value="Commoner">Commoner</option>
                            <option value="Crafts (fine)">Crafts (fine)</option>
                            <option value="Crafts (heavy)">Crafts (heavy)</option>
                            <option value="Entertainer">Entertainer</option>
                            <option value="Executioner">Executioner</option>
                            <option value="Farmer">Farmer</option>
                            <option value="Fine artist">Fine artist</option>
                            <option value="Fine smith">Fine smith</option>
                            <option value="Fisherman">Fisherman</option>
                            <option value="Gladiator">Gladiator</option>
                            <option value="Guard">Guard</option>
                            <option value="High class">High class</option>
                            <option value="Highwayman">Highwayman</option>
                            <option value="House wife">House wife</option>
                            <option value="Hunter">Hunter</option>
                            <option value="Jeweller">Jeweller</option>
                            <option value="Mage">Mage</option>
                            <option value="Mapmaker">Mapmaker</option>
                            <option value="Mason">Mason</option>
                            <option value="Merchant">Merchant</option>
                            <option value="Messenger">Messenger</option>
                            <option value="Monk">Monk</option>
                            <option value="Nanny">Nanny</option>
                            <option value="Navigator">Navigator</option>
                            <option value="Noble">Noble</option>
                            <option value="Priest">Priest</option>
                            <option value="Prostitute">Prostitute</option>
                            <option value="Ranger">Ranger</option>
                            <option value="Sage">Sage</option>
                            <option value="Sailor">Sailor</option>
                            <option value="Scholar">Scholar</option>
                            <option value="Scribe">Scribe</option>
                            <option value="Seer">Seer</option>
                            <option value="Smith">Smith</option>
                            <option value="Soldier">Soldier</option>
                            <option value="Sorcerer">Sorcerer</option>
                            <option value="Sports contender">Sports contender</option>
                            <option value="Summoner">Summoner</option>
                            <option value="Tailor">Tailor</option>
                            <option value="Tanner">Tanner</option>
                            <option value="Thief">Thief</option>
                            <option value="Tracker">Tracker</option>
                            <option value="Warrior">Warrior</option>
                            <option value="Witch (black)">Witch (black)</option>
                            <option value="Witch (white)">Witch (white)</option>
                            <option value="Wizard (air)">Wizard (air)</option>
                            <option value="Wizard (earth)">Wizard (earth)</option>
                            <option value="Wizard (fire)">Wizard (fire)</option>
                            <option value="Wizard (prot.)">Wizard (prot.)</option>
                            <option value="Wizard (water)">Wizard (water)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="npcLevel">Level:</label>
                        <select id="npcLevel" style="width: 50px;">
                            <option value="0">Rand</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="npcArea">Area:</label>
                        <select id="npcArea" style="width: 120px;">
                            <option value="">Random</option>
                            <option value="Amaronir">Amaronir</option>
                            <option value="Feronir">Feronir</option>
                            <option value="Goronir">Goronir</option>
                            <option value="Huronir">Huronir</option>
                            <option value="Koronir">Koronir</option>
                            <option value="Loronir">Loronir</option>
                            <option value="Noronir">Noronir</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="npcSex">Sex:</label>
                        <select id="npcSex" style="width: 60px;">
                            <option value="">Rand</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="npcAge">Age:</label>
                        <input type="number" id="npcAge" min="0" value="0" style="width: 80px;" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="npcHeight">H(cm):</label>
                        <input type="number" id="npcHeight" min="0" value="0" style="width: 80px;" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="npcWeight">W(kg):</label>
                        <input type="number" id="npcWeight" min="0" value="0" style="width: 80px;" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="npcDescription">Desc:</label>
                        <input type="text" id="npcDescription" placeholder="Auto" style="width: 150px;">
                    </div>
                </div>
                <button class="btn" onclick="generateNPC()" style="margin: 8px 0 0 5px; display: block;">Generate NPC</button>
            </div>

            <!-- Weather Generation Form -->
            <div class="form-container hidden" id="weatherForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 14px;">Weather Generator</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="weatherMonth">Month:</label>
                        <select id="weatherMonth" style="width: 100px;">
                            <option value="0">Random</option>
                            <option value="1">Cal Amae</option>
                            <option value="2">Elesi</option>
                            <option value="3">Anashina</option>
                            <option value="4">Gwendyll</option>
                            <option value="5">MacGillan</option>
                            <option value="6">Juba</option>
                            <option value="7">Taroc</option>
                            <option value="8">Man Peggon</option>
                            <option value="9">Maleko</option>
                            <option value="10">Fal Munir</option>
                            <option value="11">Moltan</option>
                            <option value="12">Kraagh</option>
                            <option value="13">Mestronorpha</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weatherCondition">Condition:</label>
                        <select id="weatherCondition" style="width: 120px;">
                            <option value="0">Random</option>
                            <option value="1">Clear</option>
                            <option value="3">Partly cloudy</option>
                            <option value="5">Cloudy, fog</option>
                            <option value="7">Cloudy</option>
                            <option value="9">Fog</option>
                            <option value="11">Light rain</option>
                            <option value="16">Rainy</option>
                            <option value="20">Thunderstorm</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="windDirection">Wind:</label>
                        <select id="windDirection" style="width: 60px;">
                            <option value="0">Rand</option>
                            <option value="1">N</option>
                            <option value="2">NE</option>
                            <option value="3">E</option>
                            <option value="4">SE</option>
                            <option value="5">S</option>
                            <option value="6">SW</option>
                            <option value="7">W</option>
                            <option value="8">NW</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="windStrength">Strength:</label>
                        <select id="windStrength" style="width: 80px;">
                            <option value="0">Random</option>
                            <option value="1">None</option>
                            <option value="2">Soft</option>
                            <option value="3">Windy</option>
                            <option value="4">Very windy</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="generateWeather()" style="margin: 8px 0 0 5px; display: block;">Generate Weather</button>
            </div>

            <!-- Name Generation Form -->
            <div class="form-container hidden" id="namesForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 14px;">Name Generator</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nameType">Type:</label>
                        <select id="nameType" style="width: 140px;">
                            <option value="all">Random Type</option>
                            <option value="human_male">Human Male</option>
                            <option value="human_female">Human Female</option>
                            <option value="dwarven_male">Dwarven Male</option>
                            <option value="dwarven_female">Dwarven Female</option>
                            <option value="elven_male">Elven Male</option>
                            <option value="elven_female">Elven Female</option>
                            <option value="lizardfolk">Lizardfolk</option>
                            <option value="troll">Troll</option>
                            <option value="araxi">Araxi</option>
                            <option value="fantasy_male">Fantasy Male</option>
                            <option value="fantasy_female">Fantasy Female</option>
                            <option value="places">Places</option>
                            <option value="weapons">Weapons</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nameCount">Count:</label>
                        <select id="nameCount" style="width: 50px;">
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20" selected>20</option>
                            <option value="25">25</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="generateNames()" style="margin: 8px 0 0 5px; display: block;">Generate Names</button>
            </div>

            <!-- Town Generation Form -->
            <div class="form-container hidden" id="townForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 16px;">Town/City Generator</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="townName">Name:</label>
                        <input type="text" id="townName" placeholder="Random" style="width: 140px;">
                    </div>
                    <div class="form-group">
                        <label for="townSize">Houses:</label>
                        <input type="number" id="townSize" min="1" max="200" value="1" placeholder="1" style="width: 120px;">
                    </div>
                    <div class="form-group">
                        <label for="townVar">Variation:</label>
                        <select id="townVar" style="width: 60px;">
                            <option value="0">Rand</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="generateTown()" style="margin: 8px 0 0 5px; display: block;">Generate Town</button>
            </div>

            <!-- Encounter Generation Form -->
            <div class="form-container hidden" id="encounterForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 16px;">Generate Encounter</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="encTime">Time:</label>
                        <select id="encTime" style="width: 80px;">
                            <option value="1">Day</option>
                            <option value="0">Night</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="encTerrain">Terrain:</label>
                        <select id="encTerrain" style="width: 100px;">
                            <option value="0">City</option>
                            <option value="1">Rural</option>
                            <option value="2">Road</option>
                            <option value="3">Plains</option>
                            <option value="4">Hills</option>
                            <option value="5">Mountains</option>
                            <option value="6">Woods</option>
                            <option value="7">Wilderness</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="encLevel">Level Mod:</label>
                        <input type="number" id="encLevel" min="-5" max="5" value="0" style="width: 80px;">
                    </div>
                    <div class="form-group">
                        <label for="encType">Encounter Type:</label>
                        <select id="encType" style="width: 140px;">
                            <option value="">Random</option>
                            <option value="Animal trainer">Animal trainer</option>
                            <option value="Archer">Archer</option>
                            <option value="Armour smith">Armour smith</option>
                            <option value="Army officer">Army officer</option>
                            <option value="Assassin">Assassin</option>
                            <option value="Baker/Cook">Baker/Cook</option>
                            <option value="Barbarian">Barbarian</option>
                            <option value="Bard">Bard</option>
                            <option value="Battle Mage">Battle Mage</option>
                            <option value="Berserker">Berserker</option>
                            <option value="Boatbuilder">Boatbuilder</option>
                            <option value="Body guard">Body guard</option>
                            <option value="Builder">Builder</option>
                            <option value="Bureaucrat">Bureaucrat</option>
                            <option value="Carpenter">Carpenter</option>
                            <option value="Clergyman">Clergyman</option>
                            <option value="Crafts (fine)">Crafts (fine)</option>
                            <option value="Crafts (heavy)">Crafts (heavy)</option>
                            <option value="Entertainer">Entertainer</option>
                            <option value="Executioner">Executioner</option>
                            <option value="Farmer">Farmer</option>
                            <option value="Fine artist">Fine artist</option>
                            <option value="Fine smith">Fine smith</option>
                            <option value="Fisherman">Fisherman</option>
                            <option value="Gladiator">Gladiator</option>
                            <option value="Guard">Guard</option>
                            <option value="High class">High class</option>
                            <option value="Highwayman">Highwayman</option>
                            <option value="House wife">House wife</option>
                            <option value="Hunter">Hunter</option>
                            <option value="Jeweller">Jeweller</option>
                            <option value="Large animal: Predator">Large animal: Predator</option>
                            <option value="Large animal: Prey">Large animal: Prey</option>
                            <option value="Mapmaker">Mapmaker</option>
                            <option value="Mason">Mason</option>
                            <option value="Merchant">Merchant</option>
                            <option value="Messenger">Messenger</option>
                            <option value="Monk">Monk</option>
                            <option value="Monster: Ancient Dragon">Monster: Ancient Dragon</option>
                            <option value="Monster: Basilisk">Monster: Basilisk</option>
                            <option value="Monster: Black Dragon">Monster: Black Dragon</option>
                            <option value="Monster: Blue Dragon">Monster: Blue Dragon</option>
                            <option value="Monster: Dragon">Monster: Dragon</option>
                            <option value="Monster: Drake">Monster: Drake</option>
                            <option value="Monster: Faerie">Monster: Faerie</option>
                            <option value="Monster: Giant">Monster: Giant</option>
                            <option value="Monster: Gold Dragon">Monster: Gold Dragon</option>
                            <option value="Monster: Green Dragon">Monster: Green Dragon</option>
                            <option value="Monster: Hydra">Monster: Hydra</option>
                            <option value="Monster: Lizardman">Monster: Lizardman</option>
                            <option value="Monster: Red Dragon">Monster: Red Dragon</option>
                            <option value="Monster: Skeleton">Monster: Skeleton</option>
                            <option value="Monster: Special">Monster: Special</option>
                            <option value="Monster: Troll (large)">Monster: Troll (large)</option>
                            <option value="Monster: Troll (small)">Monster: Troll (small)</option>
                            <option value="Monster: Vampire">Monster: Vampire</option>
                            <option value="Monster: Werewolf">Monster: Werewolf</option>
                            <option value="Monster: Wyvern">Monster: Wyvern</option>
                            <option value="Monster: Zombie">Monster: Zombie</option>
                            <option value="Nanny">Nanny</option>
                            <option value="Navigator">Navigator</option>
                            <option value="Noble">Noble</option>
                            <option value="Prostitute">Prostitute</option>
                            <option value="Ranger">Ranger</option>
                            <option value="Sage">Sage</option>
                            <option value="Sailor">Sailor</option>
                            <option value="Scout">Scout</option>
                            <option value="Scribe">Scribe</option>
                            <option value="Seer">Seer</option>
                            <option value="Shaman">Shaman</option>
                            <option value="Small animal: Predator">Small animal: Predator</option>
                            <option value="Small animal: Prey">Small animal: Prey</option>
                            <option value="Smith">Smith</option>
                            <option value="Soldier">Soldier</option>
                            <option value="Sorcerer">Sorcerer</option>
                            <option value="Sports contender">Sports contender</option>
                            <option value="Summoner">Summoner</option>
                            <option value="Tailor">Tailor</option>
                            <option value="Tanner">Tanner</option>
                            <option value="Thief">Thief</option>
                            <option value="Tracker">Tracker</option>
                            <option value="Warrior">Warrior</option>
                            <option value="Witch (black)">Witch (black)</option>
                            <option value="Witch (white)">Witch (white)</option>
                            <option value="Wizard (air)">Wizard (air)</option>
                            <option value="Wizard (earth)">Wizard (earth)</option>
                            <option value="Wizard (fire)">Wizard (fire)</option>
                            <option value="Wizard (prot.)">Wizard (prot.)</option>
                            <option value="Wizard (water)">Wizard (water)</option>
                            <option value="Worker">Worker</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="encNumber">Number:</label>
                        <input type="number" id="encNumber" min="0" max="20" value="0" placeholder="Random" style="width: 80px;">
                    </div>
                </div>
                <button class="btn" onclick="generateEncounter()" style="margin: 8px 0 0 5px; display: block;">Generate Encounter</button>
            </div>

            <!-- Monster Generation Form -->
            <div class="form-container hidden" id="monsterForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 16px;">Generate Monster</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="monsterType">Type:</label>
                        <select id="monsterType" style="width: 120px;">
                            <option value="">Random</option>
                            <option value="wolf">Wolf</option>
                            <option value="bear">Bear</option>
                            <option value="lion">Lion</option>
                            <option value="snake">Snake</option>
                            <option value="spider">Spider</option>
                            <option value="rat">Rat</option>
                            <option value="hawk">Hawk</option>
                            <option value="boar">Boar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monsterLevel">Level:</label>
                        <select id="monsterLevel" style="width: 60px;">
                            <option value="0">Rand</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="generateMonster()" style="margin: 8px 0 0 5px; display: block;">Generate Monster</button>
            </div>

            </div>
        </div>

        <div class="status-bar" id="statusBar">
            <span>AMAR RPG Tools v2.0</span> |
            <a href="https://d6gaming.org/" target="_blank" style="color: #f4f1e8 !important; text-decoration: underline;">Visit AMAR RPG Wiki at d6gaming.org</a>
        </div>
    </div>

    <script>
        let selectedMenuItem = 0;
        let currentFocus = 'menu';
        let lastEncounterOutput = null;  // Store the last encounter output

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            updateMenuSelection();
            setupKeyboardHandlers();
        });

        function setupKeyboardHandlers() {
            document.addEventListener('keydown', function(e) {
                if (currentFocus === 'menu') {
                    handleMenuKeyboard(e);
                } else {
                    handleContentKeyboard(e);
                }
            });
        }

        function handleMenuKeyboard(e) {
            const menuItems = document.querySelectorAll('.menu-item:not(.separator):not(.empty)');

            switch(e.key) {
                case 'ArrowDown':
                case 'j':
                    e.preventDefault();
                    selectedMenuItem = Math.min(selectedMenuItem + 1, menuItems.length - 1);
                    updateMenuSelection();
                    break;
                case 'ArrowUp':
                case 'k':
                    e.preventDefault();
                    selectedMenuItem = Math.max(selectedMenuItem - 1, 0);
                    updateMenuSelection();
                    break;
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    activateMenuItem(menuItems[selectedMenuItem]);
                    break;
                case 'Tab':
                    e.preventDefault();
                    switchFocus();
                    break;
                default:
                    // No keyboard shortcuts - prevents interference with form inputs
                    break;
            }
        }

        function handleContentKeyboard(e) {
            switch(e.key) {
                case 'Enter':
                    e.preventDefault();
                    // Find and click any visible Generate button
                    const generateButtons = document.querySelectorAll('.btn:not(.hidden)');
                    for (let button of generateButtons) {
                        if (button.textContent.includes('Generate') && button.offsetParent !== null) {
                            button.click();
                            break;
                        }
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    // Return focus to menu (like TUI 'q' behavior)
                    currentFocus = 'menu';
                    document.getElementById('menuPanel').classList.add('focused');
                    document.getElementById('contentPanel').classList.remove('focused');
                    updateStatus('Focus returned to menu - Use shortcuts or arrow keys');
                    break;
                case 'Tab':
                    e.preventDefault();
                    switchFocus();
                    break;
                default:
                    // Handle letter shortcuts from content panel too
                    const key = e.key.toLowerCase();

                    if (key === 'q') {
                        e.preventDefault();
                        // 'q' returns focus to menu (like TUI)
                        currentFocus = 'menu';
                        document.getElementById('menuPanel').classList.add('focused');
                        document.getElementById('contentPanel').classList.remove('focused');
                        updateStatus('Focus returned to menu - Use shortcuts or arrow keys');
                        return;
                    }

                    const shortcuts = {
                        'n': 'npc',
                        'e': 'encounter',
                        'm': 'monster',
                        't': 'town',
                        'w': 'weather',
                        'g': 'names',
                        'o': 'roll',
                        '?': 'help',
                    };

                    if (shortcuts[key]) {
                        // Don't activate shortcuts when typing in form fields
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                            return;
                        }
                        e.preventDefault();
                        const item = document.querySelector(`[data-action="${shortcuts[key]}"]`);
                        if (item) {
                            activateMenuItem(item);
                        }
                    }
                    break;
            }
        }

        function updateMenuSelection() {
            const menuItems = document.querySelectorAll('.menu-item:not(.separator):not(.empty)');
            menuItems.forEach((item, index) => {
                if (index === selectedMenuItem) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function switchFocus() {
            if (currentFocus === 'menu') {
                currentFocus = 'content';
                document.getElementById('menuPanel').classList.remove('focused');
                document.getElementById('contentPanel').classList.add('focused');
            } else {
                currentFocus = 'menu';
                document.getElementById('menuPanel').classList.add('focused');
                document.getElementById('contentPanel').classList.remove('focused');
            }
        }

        function activateMenuItem(item) {
            if (!item || item.classList.contains('separator') || item.classList.contains('empty')) {
                return;
            }

            const action = item.getAttribute('data-action');
            updateStatus(`Executing: ${item.textContent}`);

            switch(action) {
                case 'npc':
                    showNPCForm();
                    break;
                case 'encounter':
                    showEncounterForm();
                    break;
                case 'monster':
                    showMonsterForm();
                    break;
                case 'town':
                    showTownForm();
                    break;
                case 'weather':
                    showWeatherForm();
                    break;
                case 'names':
                    showNamesForm();
                    break;
                case 'roll':
                    rollDice();
                    break;
                case 'help':
                    showHelp();
                    break;
                    showOldNPCForm();
                    break;
                    showOldEncounterForm();
                    break;
                default:
                    updateStatus('Unknown action');
            }
        }

        function showMainView() {
            // Hide all forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show main output
            document.getElementById('output').style.display = 'block';

            // Reset focus to menu
            currentFocus = 'menu';
            document.getElementById('menuPanel').classList.add('focused');
            document.getElementById('contentPanel').classList.remove('focused');

            updateStatus('Ready | Use menu or keyboard shortcuts | ESC to return to menu');
        }

        function showNPCForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show NPC form
            document.getElementById('npcForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Fill in NPC details (optional) and click Generate | ESC to return to menu');
        }

        function showWeatherForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show weather form
            document.getElementById('weatherForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select weather parameters and click Generate | ESC to return to menu');
        }

        function showMonsterForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show monster form
            document.getElementById('monsterForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select monster parameters and click Generate | ESC to return to menu');
        }

        function showNamesForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show names form
            document.getElementById('namesForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select name options and click Generate | ESC to return to menu');
        }

        function showTownForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show town form
            document.getElementById('townForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Enter town parameters and click Generate | ESC to return to menu');
        }

        function showEncounterForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show encounter form
            document.getElementById('encounterForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select encounter parameters and click Generate | ESC to return to menu');
        }

        function showOldNPCForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show old NPC form
            document.getElementById('npcOldForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Fill in legacy NPC details and click Generate | ESC to return to menu');
        }

        function showOldEncounterForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show old encounter form
            document.getElementById('encounterOldForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select legacy encounter parameters and click Generate | ESC to return to menu');
        }

        function showNotImplemented(feature) {
            const output = document.getElementById('output');
            output.innerHTML = `<div class="error">Feature Not Yet Implemented</div>

${feature} functionality will be added in the next update.

This feature exists in the TUI version and will be ported to the web interface soon.
`;
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            updateStatus('Feature not implemented | ESC to return to menu');
        }

        async function rollDice() {
            updateStatus('Rolling dice...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Rolling open-ended d6...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/roll', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    output.innerHTML = `<div style="color: #00ffff; font-weight: bold; font-size: 16px;">OPEN ENDED D6 ROLL RESULT</div>
<div style="color: #00ffff;">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>
<div style="color: #00ffff; font-size: 18px; font-weight: bold; margin: 20px 0;">
${result.output}
</div>
`;
                    updateStatus('Dice rolled successfully | ESC to return to menu');
                } else {
                    output.innerHTML = `<div class="error">Error rolling dice</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error rolling dice | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateEncounter() {
            const params = {
                time: parseInt(document.getElementById('encTime').value),
                terrain: parseInt(document.getElementById('encTerrain').value),
                level_mod: parseInt(document.getElementById('encLevel').value) || 0,
                encounter_type: document.getElementById('encType').value || '',
                number: parseInt(document.getElementById('encNumber').value) || 0
            };

            updateStatus('Generating encounter...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating encounter, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/encounter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    // Store the encounter output for back navigation
                    lastEncounterOutput = result.output;
                    currentEditContent = result.output;

                    // Make encounter NPCs clickable for detailed view
                    const clickableOutput = makeEncountersClickable(result.output);
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('encounter', currentEditContent)">Edit Encounter</button>
                            <button class="edit-btn" onclick="downloadOutput('encounter', currentEditContent)">Download</button>
                        </div>
                        <div class="output">${clickableOutput}</div>
                    `;
                    updateStatus('Encounter generated successfully - Click names for details, Edit or Download');
                } else {
                    output.innerHTML = `<div class="error">Error generating encounter</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating encounter | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateMonster() {
            const params = {
                monster_type: document.getElementById('monsterType').value,
                level: parseInt(document.getElementById('monsterLevel').value) || 0
            };

            updateStatus('Generating monster...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating monster, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/monster', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('monster', currentEditContent)">Edit Monster</button>
                            <button class="edit-btn" onclick="downloadOutput('monster', currentEditContent)">Download</button>
                        </div>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Monster generated successfully - Edit or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating monster</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating monster | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateTown() {
            const params = {
                town_name: document.getElementById('townName').value,
                town_size: parseInt(document.getElementById('townSize').value) || 1,
                town_var: parseInt(document.getElementById('townVar').value) || 0
            };

            updateStatus('Generating town...');

            const output = document.getElementById('output');
            const houseCount = params.town_size;

            if (houseCount > 5) {
                output.innerHTML = `
                    <div class="loading">Generating town with ${houseCount} houses...</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="townProgressBar">
                            <div class="progress-text" id="townProgressText">0%</div>
                        </div>
                    </div>
                    <div id="townProgressStatus">Initializing town generation...</div>
                `;
                // Start progress simulation
                startTownProgress(houseCount);
            } else {
                output.innerHTML = '<div class="loading">Generating town, please wait...</div>';
            }
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/town', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    // Clear progress interval
                    if (townProgressInterval) {
                        clearInterval(townProgressInterval);
                        townProgressInterval = null;
                    }

                    currentEditContent = result.output;

                    // Check if town has multiple residents for relationship generation
                    // Need to check for HTML-encoded content since output contains spans
                    const containsHouse1 = result.output.includes('#1') || result.output.includes('#2') || result.output.includes('Stronghold');
                    const residentsMatch = result.output.match(/Residents: <[^>]*>(\d+)/);
                    const residentCount = residentsMatch ? parseInt(residentsMatch[1]) : 0;
                    const hasMultipleResidents = containsHouse1 || residentCount > 5;

                    console.log('DEBUG: Checking for multiple residents...');
                    console.log('DEBUG: Contains house markers:', containsHouse1);
                    console.log('DEBUG: Resident count:', residentCount);
                    console.log('DEBUG: hasMultipleResidents:', hasMultipleResidents);

                    let relationshipSection = '';
                    if (hasMultipleResidents) {
                        console.log('DEBUG: Adding relationship section...');
                        relationshipSection = `
                            <div style="margin-top: 30px; color: #00ffff; font-weight: bold;">
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            </div>
                            <div style="color: #00ffff; font-weight: bold; margin: 15px 0;">TOWN RELATIONSHIPS</div>
                            <div id="relationshipImage">
                                <div class="loading">Generating relationship diagram...</div>
                            </div>
                        `;

                        // Start relationship generation after a short delay
                        setTimeout(() => generateTownRelationships(), 500);
                    }

                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('town', currentEditContent)">Edit Town</button>
                            <button class="edit-btn" onclick="downloadOutput('town', currentEditContent)">Download</button>
                        </div>
                        <div class="output">${result.output}</div>
                        ${relationshipSection}
                    `;
                    updateStatus('Town generated successfully - Edit or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating town</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating town | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateWeather() {
            const params = {
                month: parseInt(document.getElementById('weatherMonth').value) || 0,
                condition: parseInt(document.getElementById('weatherCondition').value) || 0,
                wind_direction: parseInt(document.getElementById('windDirection').value) || 0,
                wind_strength: parseInt(document.getElementById('windStrength').value) || 0
            };

            updateStatus('Generating weather...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating weather, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/weather', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('weather', currentEditContent)">Edit Weather</button>
                            <button class="edit-btn" onclick="generateWeatherPDF()">Generate PDF</button>
                            <button class="edit-btn" onclick="downloadOutput('weather', currentEditContent)">Download</button>
                        </div>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Weather generated successfully - Edit, Generate PDF, or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating weather</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating weather | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateNames() {
            const params = {
                name_type: document.getElementById('nameType').value,
                count: parseInt(document.getElementById('nameCount').value)
            };

            updateStatus('Generating names...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating names, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/names', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    output.innerHTML = `<div class="output">${result.output}</div>
`;
                    updateStatus('Names generated successfully | ESC to return to menu');
                } else {
                    output.innerHTML = `<div class="error">Error generating names</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating names | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        function showHelp() {
            const output = document.getElementById('output');
            output.innerHTML = `<div style="color: #00ffff; font-weight: bold; font-size: 18px;">AMAR RPG TOOLS v2.0 - Enhanced 3-Tier System</div>

<div style="color: #00ffff;">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>

<div style="color: #ffff00; margin: 15px 0;">Navigation:</div>
â€¢ Click menu options to access generators
â€¢ Tab to switch between menu and content panels
â€¢ ESC to return to main menu from any form
â€¢ ðŸŽ¨ Theme toggle in header switches between Geek/Fantasy modes

<div style="color: #ffff00; margin: 15px 0;">Revolutionary 3-Tier System Features:</div>
â€¢ <span style="color: #228b22;">Generate NPC</span> - Enhanced characters with weapon assignment
â€¢ <span style="color: #228b22;">Generate Encounter</span> - 90 encounter types with detailed stats
â€¢ <span style="color: #228b22;">Generate Monster</span> - Complete monster system with abilities
â€¢ <span style="color: #00ff00;">Town/City Generator</span> - With relationships and progress bars
â€¢ <span style="color: #00ff00;">Weather Generator</span> - Enhanced with god colors and cycles
â€¢ <span style="color: #00ff00;">Name Generator</span> - Multiple cultures and types
â€¢ <span style="color: #00ff00;">Roll Open Ended d6</span> - Perfect Amar RPG dice system

<div style="color: #ffff00; margin: 15px 0;">Legacy System:</div>
â€¢ Available at: <span style="color: #00ffff;">https://isene.com/amar.html</span>
â€¢ TUI version includes both legacy and 3-tier systems

<div style="color: #ffff00; margin: 15px 0;">About:</div>
This enhanced web interface focuses on the revolutionary 3-tier system.

Version: 2.0.0
Based on: Amar RPG System by Geir Isene
`;
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            updateStatus('Help displayed | ESC to return to menu');
        }

        function showQuit() {
            const output = document.getElementById('output');
            output.innerHTML = `<div style="color: #ff6666; font-weight: bold; font-size: 18px;">Exit Application</div>

<div style="color: #ffff00; margin: 20px 0;">
To exit the web interface, simply close your browser tab or window.
</div>

<div style="color: #888;">
Thank you for using Amar RPG Tools!
</div>
`;
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            updateStatus('Close browser to exit | ESC to return to menu');
        }

        async function generateOldNPC() {
            const params = {
                name: document.getElementById('npcOldName').value,
                type: document.getElementById('npcOldType').value,
                level: parseInt(document.getElementById('npcOldLevel').value) || 0,
                area: document.getElementById('npcOldArea').value,
                sex: document.getElementById('npcOldSex').value,
                age: parseInt(document.getElementById('npcOldAge').value) || 0,
                height: parseInt(document.getElementById('npcOldHeight').value) || 0,
                weight: parseInt(document.getElementById('npcOldWeight').value) || 0,
                description: document.getElementById('npcOldDesc').value
            };

            updateStatus('Generating legacy NPC...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating NPC using legacy system...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/npc_old', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                        </div>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Legacy NPC generated - Edit or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating old NPC: ${result.error}</div>`;
                    updateStatus('Error generating old NPC');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
                updateStatus('Network error');
            }
        }

        async function generateOldEncounter() {
            const params = {
                time: parseInt(document.getElementById('encOldTime').value),
                terrain: parseInt(document.getElementById('encOldTerrain').value),
                level_mod: parseInt(document.getElementById('encOldLevel').value) || 0,
                encounter_type: document.getElementById('encOldType').value,
                number: parseInt(document.getElementById('encOldNumber').value) || 0
            };

            updateStatus('Generating legacy encounter...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating encounter using legacy system...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/encounter_old', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                        </div>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Legacy encounter generated - Edit or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating old encounter: ${result.error}</div>`;
                    updateStatus('Error generating old encounter');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
                updateStatus('Network error');
            }
        }

        function updateStatus(message) {
            document.getElementById('statusBar').textContent = message;
        }

        function toggleMobileMenu() {
            const dropdown = document.getElementById('mobileMenuDropdown');
            dropdown.classList.toggle('active');
        }

        function handleMobileMenuClick(action) {
            // Close the dropdown
            document.getElementById('mobileMenuDropdown').classList.remove('active');

            // Find the corresponding menu item and trigger its click event
            const menuItems = document.querySelectorAll('#menuPanel .menu-item');
            menuItems.forEach(item => {
                if (item.dataset.action === action) {
                    item.click();
                }
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('mobileMenuDropdown');
            const hamburger = document.getElementById('hamburgerMenu');

            if (!dropdown.contains(event.target) && event.target !== hamburger) {
                dropdown.classList.remove('active');
            }
        });

        function toggleTheme() {
            const body = document.body;
            const toggleButton = document.getElementById('themeToggleText');
            const geekUIText = document.getElementById('geekUIText');

            if (body.classList.contains('modern-theme')) {
                // Switch back to authentic geek mode
                body.classList.remove('modern-theme');
                toggleButton.textContent = 'ðŸŽ¨ Modern UI';
                localStorage.setItem('amarTheme', 'geek');
                if (geekUIText) {
                    geekUIText.innerHTML = 'You can get the TUI version as a Ruby gem. Just hop on over to the <a href="https://github.com/isene/Amar-Tools" target="_blank" style="color: #00ffff;">github repo</a>.';
                }
            } else {
                // Switch to modern fancy mode
                body.classList.add('modern-theme');
                toggleButton.textContent = 'ðŸ–¥ï¸ Geek UI';
                localStorage.setItem('amarTheme', 'modern');
                if (geekUIText) {
                    geekUIText.textContent = 'To have a whiff of how the terminal version looks like, try the Geek UI.';
                }
            }
        }

        // Load saved theme preference on page load
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('amarTheme');
            const geekUIText = document.getElementById('geekUIText');
            if (savedTheme === 'modern') {
                document.body.classList.add('modern-theme');
                document.getElementById('themeToggleText').textContent = 'ðŸ–¥ï¸ Geek UI';
                if (geekUIText) {
                    geekUIText.textContent = 'To have a whiff of how the terminal version looks like, try the Geek UI.';
                }
            } else if (savedTheme === 'geek' && geekUIText) {
                geekUIText.innerHTML = 'You can get the TUI version as a Ruby gem. Just hop on over to the <a href="https://github.com/isene/Amar-Tools" target="_blank" style="color: #00ffff;">github repo</a>.';
            }
        });

        async function generateNPC() {
            const params = {
                name: document.getElementById('npcName').value,
                type: document.getElementById('npcType').value,
                level: parseInt(document.getElementById('npcLevel').value) || 0,
                area: document.getElementById('npcArea').value,
                sex: document.getElementById('npcSex').value,
                age: parseInt(document.getElementById('npcAge').value) || 0,
                height: parseInt(document.getElementById('npcHeight').value) || 0,
                weight: parseInt(document.getElementById('npcWeight').value) || 0,
                description: document.getElementById('npcDescription').value
            };

            console.log('NPC Params:', params);

            updateStatus('Generating NPC...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating NPC, please wait...</div>';
            output.style.display = 'block';

            // Hide form
            document.getElementById('npcForm').classList.add('hidden');

            try {
                const response = await fetch('/api/npc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    // Store content and add top-positioned edit+download buttons
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('npc', currentEditContent)">Edit NPC</button>
                            <button class="edit-btn" onclick="downloadOutput('npc', currentEditContent)">Download</button>
                        </div>
                        <div class="output" id="npc-output">${result.output}</div>
                    `;
                    updateStatus('NPC generated successfully - Edit or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating NPC</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating NPC | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        function applyTUIColors(text) {
            if (!text) return '';

            // Split into lines and apply coloring
            const lines = text.split('\n');
            const coloredLines = lines.map(line => {
                // Character name line - bright cyan
                if (/^(\w+.*\([MF] \d+\).*H\/W:.*$)/.test(line)) {
                    return `<span class="fg-14 bold">${line}</span>`;
                }
                // Description line - light yellow
                else if (/^(Description:.*$)/.test(line)) {
                    return `<span class="fg-229">${line}</span>`;
                }
                // Characteristic headers - bright yellow
                else if (/^(BODY|MIND|SPIRIT)\s*\(/.test(line)) {
                    return line.replace(/^(BODY|MIND|SPIRIT)/, '<span class="fg-15 bold">$1</span>');
                }
                // Attribute names - bright magenta
                else if (/^\s+([A-Z][a-z]+)\s*\(/.test(line)) {
                    return line.replace(/^(\s+)([A-Z][a-z]+)/, '$1<span class="fg-13">$2</span>');
                }
                // Skill lines - white
                else if (/^\s+[\w\s]+:\s*\d+$/.test(line)) {
                    return `<span class="fg-7">${line}</span>`;
                }
                // Stats line - bright green
                else if (/^(SIZE:.*BP:.*DB:.*MD:.*)/.test(line)) {
                    return `<span class="fg-10 bold">${line}</span>`;
                }
                // Weapons/armor/equipment - red
                else if (/^(ARMOR:|WEAPON|WEAPONS:|EQUIPMENT:)/.test(line)) {
                    return `<span class="fg-202 bold">${line}</span>`;
                }
                else {
                    return line;
                }
            });

            return coloredLines.join('\n');
        }

        function makeEncountersClickable(output) {
            // Make encounter lines clickable for detailed NPC view
            // Pattern: "1. Name (Sex, Age) - Type [Level X]"
            const encounterPattern = /(<span[^>]*>)?(\d+)\.\s*([^<]+?)\s*\(([MF]),\s*(\d+)\)\s*-\s*([^[]+)\s*\[Level\s*(\d+)\]/g;

            return output.replace(encounterPattern, (match, spanTag, number, name, sex, age, type, level) => {
                // Clean and escape the parameters to avoid quote issues
                const cleanName = name.trim().replace(/'/g, "\\'").replace(/"/g, '\\"');
                const cleanType = type.trim().replace(/'/g, "\\'").replace(/"/g, '\\"');

                const clickableStyle = 'cursor: pointer; text-decoration: underline; transition: background-color 0.2s;';
                const hoverStyle = 'onmouseover="this.style.backgroundColor=\'#333\'" onmouseout="this.style.backgroundColor=\'transparent\'"';
                const clickHandler = `onclick="showEncounterNPCDetail('${cleanName}', '${sex}', ${age}, '${cleanType}', ${level})"`;

                if (spanTag) {
                    return `${spanTag}${number}. <span style="${clickableStyle}" ${hoverStyle} ${clickHandler}>${name.trim()} (${sex}, ${age}) - ${type.trim()} [Level ${level}]</span>`;
                } else {
                    return `${number}. <span style="${clickableStyle}" ${hoverStyle} ${clickHandler}>${name.trim()} (${sex}, ${age}) - ${type.trim()} [Level ${level}]</span>`;
                }
            });
        }

        async function showEncounterNPCDetail(name, sex, age, type, level) {
            updateStatus('Loading detailed NPC view...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating detailed NPC view...</div>';

            try {
                // Use encounter_npc endpoint to preserve encounter stats
                const params = {
                    name: name,
                    type: type,
                    level: parseInt(level),
                    sex: sex,
                    age: parseInt(age)
                };

                const response = await fetch('/api/encounter_npc/0', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    // Add a back button to return to encounter - positioned left like Generate buttons
                    output.innerHTML = `
                        <button class="btn" onclick="goBackToEncounter()" style="margin: 0 0 10px 0; display: block;">â† Back to Encounter</button>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Detailed NPC view loaded');
                } else {
                    output.innerHTML = `<div class="error">Error loading detailed view: ${result.error}</div>`;
                    updateStatus('Error loading detailed view');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
                updateStatus('Network error');
            }
        }

        function goBackToEncounter() {
            // Restore the same encounter list (don't generate new one)
            if (lastEncounterOutput) {
                currentEditContent = lastEncounterOutput;
                const output = document.getElementById('output');
                const clickableOutput = makeEncountersClickable(lastEncounterOutput);
                output.innerHTML = `
                    <button class="edit-btn" onclick="editOutput('encounter', currentEditContent)" style="margin: 0 0 10px 0;">Edit Encounter</button>
                    <div class="output">${clickableOutput}</div>
                `;
                updateStatus('Encounter list restored - Click character names for details');
            } else {
                // Fallback if no stored encounter (shouldn't happen)
                generateEncounter();
            }
        }

        // Store original content for editing
        let currentEditContent = '';
        let townProgressInterval = null;

        function startTownProgress(houseCount) {
            let progress = 0;
            const progressBar = document.getElementById('townProgressBar');
            const progressText = document.getElementById('townProgressText');
            const progressStatus = document.getElementById('townProgressStatus');

            if (!progressBar) return;

            const totalTime = Math.max(3000, houseCount * 800); // Min 3 seconds, 800ms per house
            const updateInterval = 50; // Update every 50ms
            const increment = (100 * updateInterval) / totalTime;

            const statusMessages = [
                'Initializing town generation...',
                'Creating town layout...',
                'Generating houses...',
                'Adding residents...',
                'Assigning professions...',
                'Creating families...',
                'Finalizing demographics...',
                'Calculating relationships...'
            ];

            townProgressInterval = setInterval(() => {
                progress += increment;

                if (progress >= 100) {
                    progress = 100;
                    clearInterval(townProgressInterval);
                    progressStatus.textContent = 'Completing town generation...';
                }

                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';

                // Update status message based on progress
                const statusIndex = Math.floor((progress / 100) * statusMessages.length);
                if (statusIndex < statusMessages.length) {
                    progressStatus.textContent = statusMessages[statusIndex];
                }
            }, updateInterval);
        }

        function editOutput(type, content) {
            // Store content for editing operations
            currentEditContent = content;

            // Convert HTML back to plain text for editing
            const plainText = content.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');

            const output = document.getElementById('output');
            output.innerHTML = `
                <div class="edit-container">
                    <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                        <button class="edit-btn" onclick="saveEdit('${type}')">Save Changes</button>
                        <button class="edit-btn" onclick="cancelEdit('${type}')">Cancel</button>
                    </div>
                    <textarea class="edit-textarea" id="edit-content">${plainText}</textarea>
                </div>
            `;
            updateStatus(`Editing ${type} - Modify text and click Save Changes`);

            // Focus the textarea
            document.getElementById('edit-content').focus();
        }

        function saveEdit(type) {
            const editedContent = document.getElementById('edit-content').value;

            // Convert back to HTML format - but DON'T double-escape HTML entities
            const htmlContent = editedContent.replace(/\n/g, '<br>');

            // Update stored content
            currentEditContent = htmlContent;

            const output = document.getElementById('output');
            output.innerHTML = `
                <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                    <button class="edit-btn" onclick="editOutput('${type}', currentEditContent)">Edit ${type.charAt(0).toUpperCase() + type.slice(1)}</button>
                    <button class="edit-btn" onclick="downloadOutput('${type}', currentEditContent)">Download</button>
                </div>
                <div class="output">${htmlContent}</div>
            `;
            updateStatus(`${type.charAt(0).toUpperCase() + type.slice(1)} edited and saved`);
        }

        function cancelEdit(type) {
            const output = document.getElementById('output');
            output.innerHTML = `
                <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                    <button class="edit-btn" onclick="editOutput('${type}', currentEditContent)">Edit ${type.charAt(0).toUpperCase() + type.slice(1)}</button>
                    <button class="edit-btn" onclick="downloadOutput('${type}', currentEditContent)">Download</button>
                </div>
                <div class="output">${currentEditContent}</div>
            `;
            updateStatus('Edit cancelled - original content restored');
        }

        function downloadOutput(type, content) {
            // Convert HTML to plain text for download
            const plainText = content.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');

            // Create download
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `amar-${type}-${timestamp}.txt`;

            const blob = new Blob([plainText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            updateStatus(`${type.charAt(0).toUpperCase() + type.slice(1)} downloaded as ${filename}`);
        }

        async function generateTownRelationships() {
            console.log('DEBUG: Starting relationship generation...');
            console.log('DEBUG: Town data:', currentEditContent);

            try {
                const response = await fetch('/api/town_relationships', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        town_data: currentEditContent
                    })
                });

                const result = await response.json();
                console.log('DEBUG: Relationship API response:', result);

                const relationshipDiv = document.getElementById('relationshipImage');

                if (result.success && relationshipDiv) {
                    console.log('DEBUG: Setting relationship image:', result.image_url);
                    relationshipDiv.innerHTML = `<img src="${result.image_url}?t=${Date.now()}" style="max-width: 100%; border: 1px solid #555;" alt="Town Relationships">`;
                } else {
                    console.log('DEBUG: Relationship generation failed:', result.error);
                    relationshipDiv.innerHTML = `<div style="color: #ff6666;">Unable to generate relationship diagram<br>Error: ${result.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.log('DEBUG: Relationship generation exception:', error);
                const relationshipDiv = document.getElementById('relationshipImage');
                if (relationshipDiv) {
                    relationshipDiv.innerHTML = `<div style="color: #ff6666;">Error generating relationships: ${error.message}</div>`;
                }
            }
        }

        function downloadWeatherPDF() {
            // Download the generated PDF file
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const link = document.createElement('a');
            link.href = '/download/weather.pdf';
            link.download = `amar-weather-${timestamp}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            updateStatus('Weather PDF download initiated');
        }

        async function generateWeatherPDF() {
            updateStatus('Generating weather PDF...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating weather PDF, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/weather_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('weather-pdf', currentEditContent)">Edit PDF Info</button>
                            <button class="edit-btn" onclick="downloadOutput('weather-pdf', currentEditContent)">Download Info</button>
                            <button class="edit-btn" onclick="downloadWeatherPDF()">Download PDF</button>
                        </div>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Weather PDF generated - Download PDF button available');
                } else {
                    output.innerHTML = `<div class="error">Error generating weather PDF: ${result.error}</div>`;
                    updateStatus('Error generating weather PDF');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
                updateStatus('Network error');
            }
        }

        // Click handlers for menu items and focus switching
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('menu-item') && !e.target.classList.contains('separator') && !e.target.classList.contains('empty')) {
                // Update menu selection to clicked item
                const menuItems = document.querySelectorAll('.menu-item:not(.separator):not(.empty)');
                for (let i = 0; i < menuItems.length; i++) {
                    if (menuItems[i] === e.target) {
                        selectedMenuItem = i;
                        updateMenuSelection();
                        break;
                    }
                }
                activateMenuItem(e.target);
            }

            // Switch focus when clicking on panels
            if (e.target.closest('#menuPanel') || e.target.closest('.menu-panel')) {
                if (currentFocus !== 'menu') {
                    currentFocus = 'menu';
                    document.getElementById('menuPanel').classList.add('focused');
                    document.getElementById('contentPanel').classList.remove('focused');
                }
            } else if (e.target.closest('#contentPanel') || e.target.closest('.content-panel')) {
                if (currentFocus !== 'content') {
                    currentFocus = 'content';
                    document.getElementById('menuPanel').classList.remove('focused');
                    document.getElementById('contentPanel').classList.add('focused');
                }
            }
        });
    </script>
</body>
</html>