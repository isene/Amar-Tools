<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amar RPG Tools - Web Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 2px;
        }

        .header {
            grid-column: 1 / -1;
            background-color: #1a1a1a;
            padding: 10px;
            border: 2px solid #555;
            text-align: center;
        }

        .title {
            color: #00ffff;
            font-weight: bold;
            font-size: 18px;
        }

        .menu-panel {
            background-color: #000;
            border: 2px solid #555;
            padding: 10px;
            overflow-y: auto;
        }

        .menu-panel.focused {
            border-color: #00ffff;
        }

        .content-panel {
            background-color: #000;
            border: 2px solid #555;
            padding: 5px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .content-panel.focused {
            border-color: #00ffff;
        }

        .status-bar {
            grid-column: 1 / -1;
            background-color: #333;
            padding: 5px 10px;
            border: 1px solid #555;
            font-size: 12px;
            color: #ccc;
        }

        .menu-item {
            padding: 2px 5px;
            cursor: pointer;
            border-radius: 2px;
            margin: 1px 0;
        }

        .menu-item.separator {
            color: #888;
            cursor: default;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
        }

        .menu-item.empty {
            height: 10px;
            cursor: default;
        }

        .menu-item:hover:not(.separator):not(.empty) {
            background-color: #333;
        }

        .menu-item.selected {
            background-color: #444;
            color: #00ffff;
            font-weight: bold;
        }

        .form-container {
            margin: 0;
            padding: 0;
            background-color: transparent;
            border: none;
            width: 100%;
            align-self: stretch;
        }

        .output {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.2;
            width: 100%;
            align-self: stretch;
        }

        .form-group {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label {
            color: #00ffff;
            font-weight: bold;
            min-width: 70px;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin: 4px 0;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 140px;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 6px 8px;
            background-color: #333;
            border: 1px solid #555;
            color: #fff;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
            font-size: 16px;
            height: 36px;
        }

        /* Remove number input spinners */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .btn {
            background-color: #444;
            color: #00ffff;
            border: 1px solid #00ffff;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 3px;
            margin: 0;
        }

        .btn:hover {
            background-color: #555;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .btn:disabled {
            background-color: #222;
            color: #666;
            border-color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }


        .loading {
            color: #ffff00;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .hidden {
            display: none;
        }

        .error {
            color: #ff4444;
            background-color: #330000;
            padding: 10px;
            border: 1px solid #ff4444;
            border-radius: 3px;
            margin: 10px 0;
        }

        .success {
            color: #44ff44;
            background-color: #003300;
            padding: 10px;
            border: 1px solid #44ff44;
            border-radius: 3px;
            margin: 10px 0;
        }

        .edit-container {
            margin: 10px 0;
            padding: 0;
        }

        .edit-textarea {
            width: 100%;
            min-height: 400px;
            background-color: #000;
            color: #fff;
            border: 1px solid #555;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.2;
            resize: vertical;
            white-space: pre;
        }

        .edit-buttons {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }

        .edit-btn {
            background-color: #444;
            color: #00ffff;
            border: 1px solid #00ffff;
            padding: 6px 12px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 3px;
            font-size: 12px;
        }

        .edit-btn:hover {
            background-color: #555;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        /* Color classes for TUI output */
        .fg-14 { color: #00ffff; }  /* bright cyan */
        .fg-229 { color: #ffffaf; } /* light yellow */
        .fg-15 { color: #ffffff; }  /* bright white */
        .fg-13 { color: #ff00ff; }  /* bright magenta */
        .fg-7 { color: #c0c0c0; }   /* white */
        .fg-10 { color: #00ff00; }  /* bright green */
        .fg-202 { color: #ff5f00; } /* red-orange */
        .bold { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">AMAR RPG TOOLS - Web Interface v1.0.0</div>
        </div>

        <div class="menu-panel focused" id="menuPanel">
            <div class="menu-item separator" style="color: #2AA52A; text-align: left;">NEW 3-TIER SYSTEM</div>
            <div class="menu-item" data-action="npc">N. Generate NPC</div>
            <div class="menu-item" data-action="encounter">E. Generate Encounter</div>
            <div class="menu-item" data-action="monster">M. Generate Monster</div>
            <div class="menu-item empty"></div>
            <div class="menu-item separator" style="color: #42A5A5; text-align: left;">WORLD BUILDING</div>
            <div class="menu-item" data-action="town">T. Town/City Generator</div>
            <div class="menu-item" data-action="weather">W. Weather Generator</div>
            <div class="menu-item" data-action="names">G. Name Generator</div>
            <div class="menu-item empty"></div>
            <div class="menu-item separator" style="color: #855A85; text-align: left;">UTILITIES</div>
            <div class="menu-item" data-action="roll">O. Roll Open Ended d6</div>
            <div class="menu-item" data-action="help">?. Help</div>
        </div>

        <div class="content-panel" id="contentPanel">
            <div class="output" id="output">Welcome to the Amar RPG Tools Web Interface!

Select an option from the menu on the left to get started.

This web interface provides the exact same functionality as the TUI version,
with all the same generators and tools available through a convenient web browser.

Key Features:
• Generate NPCs with full character stats
• Create encounters and monsters
• Build towns and generate weather
• AI-powered adventure and description tools
• Name generators for various cultures
• Roll dice and access utilities

Navigation: Click on menu items or use keyboard shortcuts (N, E, M, etc.)
            </div>

            <!-- NPC Generation Form -->
            <div class="form-container hidden" id="npcForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 14px;">Generate NPC</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="npcName">Name:</label>
                        <input type="text" id="npcName" placeholder="Random" style="width: 120px;">
                    </div>
                    <div class="form-group">
                        <label for="npcType">Type:</label>
                        <select id="npcType" style="width: 140px;">
                            <option value="">Random</option>
                            <option value="Animal trainer">Animal trainer</option>
                            <option value="Archer">Archer</option>
                            <option value="Armour smith">Armour smith</option>
                            <option value="Army officer">Army officer</option>
                            <option value="Assassin">Assassin</option>
                            <option value="Baker/Cook">Baker/Cook</option>
                            <option value="Bandit">Bandit</option>
                            <option value="Bard">Bard</option>
                            <option value="Boatbuilder">Boatbuilder</option>
                            <option value="Body guard">Body guard</option>
                            <option value="Builder">Builder</option>
                            <option value="Bureaucrat">Bureaucrat</option>
                            <option value="Carpenter">Carpenter</option>
                            <option value="Clergyman">Clergyman</option>
                            <option value="Commoner">Commoner</option>
                            <option value="Crafts (fine)">Crafts (fine)</option>
                            <option value="Crafts (heavy)">Crafts (heavy)</option>
                            <option value="Entertainer">Entertainer</option>
                            <option value="Executioner">Executioner</option>
                            <option value="Farmer">Farmer</option>
                            <option value="Fine artist">Fine artist</option>
                            <option value="Fine smith">Fine smith</option>
                            <option value="Fisherman">Fisherman</option>
                            <option value="Gladiator">Gladiator</option>
                            <option value="Guard">Guard</option>
                            <option value="High class">High class</option>
                            <option value="Highwayman">Highwayman</option>
                            <option value="House wife">House wife</option>
                            <option value="Hunter">Hunter</option>
                            <option value="Jeweller">Jeweller</option>
                            <option value="Mage">Mage</option>
                            <option value="Mapmaker">Mapmaker</option>
                            <option value="Mason">Mason</option>
                            <option value="Merchant">Merchant</option>
                            <option value="Messenger">Messenger</option>
                            <option value="Monk">Monk</option>
                            <option value="Nanny">Nanny</option>
                            <option value="Navigator">Navigator</option>
                            <option value="Noble">Noble</option>
                            <option value="Priest">Priest</option>
                            <option value="Prostitute">Prostitute</option>
                            <option value="Ranger">Ranger</option>
                            <option value="Sage">Sage</option>
                            <option value="Sailor">Sailor</option>
                            <option value="Scholar">Scholar</option>
                            <option value="Scribe">Scribe</option>
                            <option value="Seer">Seer</option>
                            <option value="Smith">Smith</option>
                            <option value="Soldier">Soldier</option>
                            <option value="Sorcerer">Sorcerer</option>
                            <option value="Sports contender">Sports contender</option>
                            <option value="Summoner">Summoner</option>
                            <option value="Tailor">Tailor</option>
                            <option value="Tanner">Tanner</option>
                            <option value="Thief">Thief</option>
                            <option value="Tracker">Tracker</option>
                            <option value="Warrior">Warrior</option>
                            <option value="Witch (black)">Witch (black)</option>
                            <option value="Witch (white)">Witch (white)</option>
                            <option value="Wizard (air)">Wizard (air)</option>
                            <option value="Wizard (earth)">Wizard (earth)</option>
                            <option value="Wizard (fire)">Wizard (fire)</option>
                            <option value="Wizard (prot.)">Wizard (prot.)</option>
                            <option value="Wizard (water)">Wizard (water)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="npcLevel">Level:</label>
                        <select id="npcLevel" style="width: 50px;">
                            <option value="0">Rand</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="npcArea">Area:</label>
                        <select id="npcArea" style="width: 120px;">
                            <option value="">Random</option>
                            <option value="Amaronir">Amaronir</option>
                            <option value="Feronir">Feronir</option>
                            <option value="Goronir">Goronir</option>
                            <option value="Huronir">Huronir</option>
                            <option value="Koronir">Koronir</option>
                            <option value="Loronir">Loronir</option>
                            <option value="Noronir">Noronir</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="npcSex">Sex:</label>
                        <select id="npcSex" style="width: 60px;">
                            <option value="">Rand</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="npcAge">Age:</label>
                        <input type="number" id="npcAge" min="0" value="0" style="width: 80px;" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="npcHeight">H(cm):</label>
                        <input type="number" id="npcHeight" min="0" value="0" style="width: 80px;" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="npcWeight">W(kg):</label>
                        <input type="number" id="npcWeight" min="0" value="0" style="width: 80px;" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="npcDescription">Desc:</label>
                        <input type="text" id="npcDescription" placeholder="Auto" style="width: 150px;">
                    </div>
                </div>
                <button class="btn" onclick="generateNPC()" style="margin: 8px 0 0 5px; display: block;">Generate NPC</button>
            </div>

            <!-- Weather Generation Form -->
            <div class="form-container hidden" id="weatherForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 14px;">Weather Generator</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="weatherMonth">Month:</label>
                        <select id="weatherMonth" style="width: 100px;">
                            <option value="0">Random</option>
                            <option value="1">Cal Amae</option>
                            <option value="2">Elesi</option>
                            <option value="3">Anashina</option>
                            <option value="4">Gwendyll</option>
                            <option value="5">MacGillan</option>
                            <option value="6">Juba</option>
                            <option value="7">Taroc</option>
                            <option value="8">Man Peggon</option>
                            <option value="9">Maleko</option>
                            <option value="10">Fal Munir</option>
                            <option value="11">Moltan</option>
                            <option value="12">Kraagh</option>
                            <option value="13">Mestronorpha</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weatherCondition">Condition:</label>
                        <select id="weatherCondition" style="width: 120px;">
                            <option value="0">Random</option>
                            <option value="1">Clear</option>
                            <option value="3">Partly cloudy</option>
                            <option value="5">Cloudy, fog</option>
                            <option value="7">Cloudy</option>
                            <option value="9">Fog</option>
                            <option value="11">Light rain</option>
                            <option value="16">Rainy</option>
                            <option value="20">Thunderstorm</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="windDirection">Wind:</label>
                        <select id="windDirection" style="width: 60px;">
                            <option value="0">Rand</option>
                            <option value="1">N</option>
                            <option value="2">NE</option>
                            <option value="3">E</option>
                            <option value="4">SE</option>
                            <option value="5">S</option>
                            <option value="6">SW</option>
                            <option value="7">W</option>
                            <option value="8">NW</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="windStrength">Strength:</label>
                        <select id="windStrength" style="width: 80px;">
                            <option value="0">Random</option>
                            <option value="1">None</option>
                            <option value="2">Soft</option>
                            <option value="3">Windy</option>
                            <option value="4">Very windy</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="generateWeather()" style="margin: 8px 0 0 5px; display: block;">Generate Weather</button>
            </div>

            <!-- Name Generation Form -->
            <div class="form-container hidden" id="namesForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 14px;">Name Generator</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nameType">Type:</label>
                        <select id="nameType" style="width: 140px;">
                            <option value="all">Random Type</option>
                            <option value="human_male">Human Male</option>
                            <option value="human_female">Human Female</option>
                            <option value="dwarven_male">Dwarven Male</option>
                            <option value="dwarven_female">Dwarven Female</option>
                            <option value="elven_male">Elven Male</option>
                            <option value="elven_female">Elven Female</option>
                            <option value="lizardfolk">Lizardfolk</option>
                            <option value="troll">Troll</option>
                            <option value="araxi">Araxi</option>
                            <option value="fantasy_male">Fantasy Male</option>
                            <option value="fantasy_female">Fantasy Female</option>
                            <option value="places">Places</option>
                            <option value="weapons">Weapons</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nameCount">Count:</label>
                        <select id="nameCount" style="width: 50px;">
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20" selected>20</option>
                            <option value="25">25</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="generateNames()" style="margin: 8px 0 0 5px; display: block;">Generate Names</button>
            </div>

            <!-- Town Generation Form -->
            <div class="form-container hidden" id="townForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 16px;">Town/City Generator</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="townName">Name:</label>
                        <input type="text" id="townName" placeholder="Random" style="width: 140px;">
                    </div>
                    <div class="form-group">
                        <label for="townSize">Houses:</label>
                        <input type="number" id="townSize" min="1" max="200" value="0" placeholder="Random (max 200)" style="width: 120px;">
                    </div>
                    <div class="form-group">
                        <label for="townVar">Variation:</label>
                        <select id="townVar" style="width: 60px;">
                            <option value="0">Rand</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="generateTown()" style="margin: 8px 0 0 5px; display: block;">Generate Town</button>
            </div>

            <!-- Encounter Generation Form -->
            <div class="form-container hidden" id="encounterForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 16px;">Generate Encounter</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="encTime">Time:</label>
                        <select id="encTime" style="width: 80px;">
                            <option value="1">Day</option>
                            <option value="0">Night</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="encTerrain">Terrain:</label>
                        <select id="encTerrain" style="width: 100px;">
                            <option value="0">City</option>
                            <option value="1">Rural</option>
                            <option value="2">Road</option>
                            <option value="3">Plains</option>
                            <option value="4">Hills</option>
                            <option value="5">Mountains</option>
                            <option value="6">Woods</option>
                            <option value="7">Wilderness</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="encLevel">Level Mod:</label>
                        <input type="number" id="encLevel" min="-5" max="5" value="0" style="width: 80px;">
                    </div>
                    <div class="form-group">
                        <label for="encRace">Race:</label>
                        <select id="encRace" style="width: 100px;">
                            <option value="0">Random</option>
                            <option value="1">Human</option>
                            <option value="2">Elf</option>
                            <option value="3">Half-elf</option>
                            <option value="4">Dwarf</option>
                            <option value="5">Goblin</option>
                            <option value="6">Lizard Man</option>
                            <option value="7">Centaur</option>
                            <option value="8">Ogre</option>
                            <option value="9">Troll</option>
                            <option value="10">Araxi</option>
                            <option value="11">Faerie</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="encNumber">Number:</label>
                        <input type="number" id="encNumber" min="0" max="20" value="0" placeholder="Random" style="width: 80px;">
                    </div>
                </div>
                <button class="btn" onclick="generateEncounter()" style="margin: 8px 0 0 5px; display: block;">Generate Encounter</button>
            </div>

            <!-- Monster Generation Form -->
            <div class="form-container hidden" id="monsterForm">
                <h3 style="color: #00ffff; margin: 0 0 8px 0; font-size: 16px;">Generate Monster</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="monsterType">Type:</label>
                        <select id="monsterType" style="width: 120px;">
                            <option value="">Random</option>
                            <option value="wolf">Wolf</option>
                            <option value="bear">Bear</option>
                            <option value="lion">Lion</option>
                            <option value="snake">Snake</option>
                            <option value="spider">Spider</option>
                            <option value="rat">Rat</option>
                            <option value="hawk">Hawk</option>
                            <option value="boar">Boar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monsterLevel">Level:</label>
                        <select id="monsterLevel" style="width: 60px;">
                            <option value="0">Rand</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="generateMonster()" style="margin: 8px 0 0 5px; display: block;">Generate Monster</button>
            </div>
        </div>

        <div class="status-bar" id="statusBar">
            Ready | Use menu or keyboard shortcuts | TAB to switch panes | ESC to return to menu
        </div>
    </div>

    <script>
        let selectedMenuItem = 0;
        let currentFocus = 'menu';
        let lastEncounterOutput = null;  // Store the last encounter output

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            updateMenuSelection();
            setupKeyboardHandlers();
        });

        function setupKeyboardHandlers() {
            document.addEventListener('keydown', function(e) {
                if (currentFocus === 'menu') {
                    handleMenuKeyboard(e);
                } else {
                    handleContentKeyboard(e);
                }
            });
        }

        function handleMenuKeyboard(e) {
            const menuItems = document.querySelectorAll('.menu-item:not(.separator):not(.empty)');

            switch(e.key) {
                case 'ArrowDown':
                case 'j':
                    e.preventDefault();
                    selectedMenuItem = Math.min(selectedMenuItem + 1, menuItems.length - 1);
                    updateMenuSelection();
                    break;
                case 'ArrowUp':
                case 'k':
                    e.preventDefault();
                    selectedMenuItem = Math.max(selectedMenuItem - 1, 0);
                    updateMenuSelection();
                    break;
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    activateMenuItem(menuItems[selectedMenuItem]);
                    break;
                case 'Tab':
                    e.preventDefault();
                    switchFocus();
                    break;
                default:
                    // Handle letter shortcuts
                    const key = e.key.toLowerCase();
                    const shortcuts = {
                        'n': 'npc',
                        'e': 'encounter',
                        'm': 'monster',
                        't': 'town',
                        'w': 'weather',
                        'g': 'names',
                        'o': 'roll',
                        '?': 'help'
                    };

                    if (shortcuts[key]) {
                        e.preventDefault();
                        const item = document.querySelector(`[data-action="${shortcuts[key]}"]`);
                        if (item) {
                            activateMenuItem(item);
                        }
                    }
                    break;
            }
        }

        function handleContentKeyboard(e) {
            switch(e.key) {
                case 'Escape':
                    e.preventDefault();
                    showMainView();
                    break;
                case 'Tab':
                    e.preventDefault();
                    switchFocus();
                    break;
                default:
                    // Handle letter shortcuts from content panel too
                    const key = e.key.toLowerCase();
                    const shortcuts = {
                        'n': 'npc',
                        'e': 'encounter',
                        'm': 'monster',
                        't': 'town',
                        'w': 'weather',
                        'g': 'names',
                        'o': 'roll',
                        '?': 'help'
                    };

                    if (shortcuts[key]) {
                        e.preventDefault();
                        const item = document.querySelector(`[data-action="${shortcuts[key]}"]`);
                        if (item) {
                            activateMenuItem(item);
                        }
                    }
                    break;
            }
        }

        function updateMenuSelection() {
            const menuItems = document.querySelectorAll('.menu-item:not(.separator):not(.empty)');
            menuItems.forEach((item, index) => {
                if (index === selectedMenuItem) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function switchFocus() {
            if (currentFocus === 'menu') {
                currentFocus = 'content';
                document.getElementById('menuPanel').classList.remove('focused');
                document.getElementById('contentPanel').classList.add('focused');
            } else {
                currentFocus = 'menu';
                document.getElementById('menuPanel').classList.add('focused');
                document.getElementById('contentPanel').classList.remove('focused');
            }
        }

        function activateMenuItem(item) {
            if (!item || item.classList.contains('separator') || item.classList.contains('empty')) {
                return;
            }

            const action = item.getAttribute('data-action');
            updateStatus(`Executing: ${item.textContent}`);

            switch(action) {
                case 'npc':
                    showNPCForm();
                    break;
                case 'encounter':
                    showEncounterForm();
                    break;
                case 'monster':
                    showMonsterForm();
                    break;
                case 'town':
                    showTownForm();
                    break;
                case 'weather':
                    showWeatherForm();
                    break;
                case 'names':
                    showNamesForm();
                    break;
                case 'roll':
                    rollDice();
                    break;
                case 'help':
                    showHelp();
                    break;
                default:
                    updateStatus('Unknown action');
            }
        }

        function showMainView() {
            // Hide all forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show main output
            document.getElementById('output').style.display = 'block';

            // Reset focus to menu
            currentFocus = 'menu';
            document.getElementById('menuPanel').classList.add('focused');
            document.getElementById('contentPanel').classList.remove('focused');

            updateStatus('Ready | Use menu or keyboard shortcuts | ESC to return to menu');
        }

        function showNPCForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show NPC form
            document.getElementById('npcForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Fill in NPC details (optional) and click Generate | ESC to return to menu');
        }

        function showWeatherForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show weather form
            document.getElementById('weatherForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select weather parameters and click Generate | ESC to return to menu');
        }

        function showMonsterForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show monster form
            document.getElementById('monsterForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select monster parameters and click Generate | ESC to return to menu');
        }

        function showNamesForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show names form
            document.getElementById('namesForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select name options and click Generate | ESC to return to menu');
        }

        function showTownForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show town form
            document.getElementById('townForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Enter town parameters and click Generate | ESC to return to menu');
        }

        function showEncounterForm() {
            // Hide all other content first
            document.getElementById('output').style.display = 'none';
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            // Show encounter form
            document.getElementById('encounterForm').classList.remove('hidden');
            currentFocus = 'content';
            document.getElementById('menuPanel').classList.remove('focused');
            document.getElementById('contentPanel').classList.add('focused');
            updateStatus('Select encounter parameters and click Generate | ESC to return to menu');
        }

        function showNotImplemented(feature) {
            const output = document.getElementById('output');
            output.innerHTML = `<div class="error">Feature Not Yet Implemented</div>

${feature} functionality will be added in the next update.

This feature exists in the TUI version and will be ported to the web interface soon.
`;
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            updateStatus('Feature not implemented | ESC to return to menu');
        }

        async function rollDice() {
            updateStatus('Rolling dice...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Rolling open-ended d6...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/roll', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    output.innerHTML = `<div class="success">Open Ended d6 Roll Result</div>

<div style="color: #00ffff; font-size: 18px; font-weight: bold; margin: 20px 0;">
${result.output}
</div>
`;
                    updateStatus('Dice rolled successfully | ESC to return to menu');
                } else {
                    output.innerHTML = `<div class="error">Error rolling dice</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error rolling dice | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateEncounter() {
            const params = {
                time: parseInt(document.getElementById('encTime').value),
                terrain: parseInt(document.getElementById('encTerrain').value),
                level_mod: parseInt(document.getElementById('encLevel').value) || 0,
                race: parseInt(document.getElementById('encRace').value) || 0,
                number: parseInt(document.getElementById('encNumber').value) || 0
            };

            updateStatus('Generating encounter...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating encounter, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/encounter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    // Store the encounter output for back navigation
                    lastEncounterOutput = result.output;
                    currentEditContent = result.output;

                    // Make encounter NPCs clickable for detailed view
                    const clickableOutput = makeEncountersClickable(result.output);
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('encounter', currentEditContent)">Edit Encounter</button>
                            <button class="edit-btn" onclick="downloadOutput('encounter', currentEditContent)">Download</button>
                        </div>
                        <div class="output">${clickableOutput}</div>
                    `;
                    updateStatus('Encounter generated successfully - Click names for details, Edit or Download');
                } else {
                    output.innerHTML = `<div class="error">Error generating encounter</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating encounter | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateMonster() {
            const params = {
                monster_type: document.getElementById('monsterType').value,
                level: parseInt(document.getElementById('monsterLevel').value) || 0
            };

            updateStatus('Generating monster...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating monster, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/monster', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('monster', currentEditContent)">Edit Monster</button>
                            <button class="edit-btn" onclick="downloadOutput('monster', currentEditContent)">Download</button>
                        </div>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Monster generated successfully - Edit or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating monster</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating monster | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateTown() {
            const params = {
                town_name: document.getElementById('townName').value,
                town_size: parseInt(document.getElementById('townSize').value) || 0,
                town_var: parseInt(document.getElementById('townVar').value) || 0
            };

            const output = document.getElementById('output');
            const houseCount = params.town_size || 0;

            if (houseCount > 50) {
                updateStatus(`Generating large town (${houseCount} houses) - this may take a moment...`);
                output.innerHTML = `<div class="loading">Generating town with ${houseCount} houses...<br>Please wait, this may take up to a minute for large towns.</div>`;
            } else {
                updateStatus('Generating town...');
                output.innerHTML = '<div class="loading">Generating town, please wait...</div>';
            }

            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/town', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    output.innerHTML = `<div class="output">${result.output}</div>
`;
                    updateStatus('Town generated successfully | ESC to return to menu');
                } else {
                    output.innerHTML = `<div class="error">Error generating town</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating town | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateWeather() {
            const params = {
                month: parseInt(document.getElementById('weatherMonth').value) || 0,
                condition: parseInt(document.getElementById('weatherCondition').value) || 0,
                wind_direction: parseInt(document.getElementById('windDirection').value) || 0,
                wind_strength: parseInt(document.getElementById('windStrength').value) || 0
            };

            updateStatus('Generating weather...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating weather, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/weather', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('weather', currentEditContent)">Edit Weather</button>
                            <button class="edit-btn" onclick="generateWeatherPDF()">Generate PDF</button>
                            <button class="edit-btn" onclick="downloadOutput('weather', currentEditContent)">Download</button>
                        </div>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Weather generated successfully - Edit, Generate PDF, or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating weather</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating weather | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        async function generateNames() {
            const params = {
                name_type: document.getElementById('nameType').value,
                count: parseInt(document.getElementById('nameCount').value)
            };

            updateStatus('Generating names...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating names, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/names', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    output.innerHTML = `<div class="output">${result.output}</div>
`;
                    updateStatus('Names generated successfully | ESC to return to menu');
                } else {
                    output.innerHTML = `<div class="error">Error generating names</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating names | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        function showHelp() {
            const output = document.getElementById('output');
            output.innerHTML = `<div style="color: #00ffff; font-weight: bold; font-size: 18px;">AMAR RPG TOOLS - Help</div>

<div style="color: #ffff00; margin: 15px 0;">Navigation:</div>
• Use arrow keys or J/K to navigate menu
• Press Enter or Space to select menu items
• Use letter shortcuts (N for NPC, E for Encounter, etc.)
• Tab to switch between menu and content panels
• ESC to return to main menu from any form

<div style="color: #ffff00; margin: 15px 0;">Features:</div>
• <span style="color: #00ff00;">NPC Generator</span> - Create detailed characters with stats
• <span style="color: #888;">Encounter Generator</span> - Coming soon
• <span style="color: #888;">Monster Generator</span> - Coming soon
• <span style="color: #888;">World Building Tools</span> - Coming soon
• <span style="color: #888;">AI Tools</span> - Coming soon
• <span style="color: #00ff00;">Dice Rolling</span> - Open-ended d6 system
• <span style="color: #888;">Legacy Tools</span> - Coming soon

<div style="color: #ffff00; margin: 15px 0;">About:</div>
This web interface provides the same functionality as the TUI version,
allowing you to access all Amar RPG tools through your web browser.

Version: 1.0.0
Based on: Amar RPG System by Geir Isene
`;
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            updateStatus('Help displayed | ESC to return to menu');
        }

        function showQuit() {
            const output = document.getElementById('output');
            output.innerHTML = `<div style="color: #ff6666; font-weight: bold; font-size: 18px;">Exit Application</div>

<div style="color: #ffff00; margin: 20px 0;">
To exit the web interface, simply close your browser tab or window.
</div>

<div style="color: #888;">
Thank you for using Amar RPG Tools!
</div>
`;
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            updateStatus('Close browser to exit | ESC to return to menu');
        }

        function updateStatus(message) {
            document.getElementById('statusBar').textContent = message;
        }

        async function generateNPC() {
            const params = {
                name: document.getElementById('npcName').value,
                type: document.getElementById('npcType').value,
                level: parseInt(document.getElementById('npcLevel').value) || 0,
                area: document.getElementById('npcArea').value,
                sex: document.getElementById('npcSex').value,
                age: parseInt(document.getElementById('npcAge').value) || 0,
                height: parseInt(document.getElementById('npcHeight').value) || 0,
                weight: parseInt(document.getElementById('npcWeight').value) || 0,
                description: document.getElementById('npcDescription').value
            };

            console.log('NPC Params:', params);

            updateStatus('Generating NPC...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating NPC, please wait...</div>';
            output.style.display = 'block';

            // Hide form
            document.getElementById('npcForm').classList.add('hidden');

            try {
                const response = await fetch('/api/npc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    // Store content and add top-positioned edit+download buttons
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('npc', currentEditContent)">Edit NPC</button>
                            <button class="edit-btn" onclick="downloadOutput('npc', currentEditContent)">Download</button>
                        </div>
                        <div class="output" id="npc-output">${result.output}</div>
                    `;
                    updateStatus('NPC generated successfully - Edit or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating NPC</div>

<div style="color: #ff6666;">
${result.error || 'Unknown error occurred'}
</div>
`;
                    updateStatus('Error generating NPC | ESC to return to menu');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network Error</div>

<div style="color: #ff6666;">
Failed to connect to server: ${error.message}
</div>
`;
                updateStatus('Network error | ESC to return to menu');
            }
        }

        function applyTUIColors(text) {
            if (!text) return '';

            // Split into lines and apply coloring
            const lines = text.split('\n');
            const coloredLines = lines.map(line => {
                // Character name line - bright cyan
                if (/^(\w+.*\([MF] \d+\).*H\/W:.*$)/.test(line)) {
                    return `<span class="fg-14 bold">${line}</span>`;
                }
                // Description line - light yellow
                else if (/^(Description:.*$)/.test(line)) {
                    return `<span class="fg-229">${line}</span>`;
                }
                // Characteristic headers - bright yellow
                else if (/^(BODY|MIND|SPIRIT)\s*\(/.test(line)) {
                    return line.replace(/^(BODY|MIND|SPIRIT)/, '<span class="fg-15 bold">$1</span>');
                }
                // Attribute names - bright magenta
                else if (/^\s+([A-Z][a-z]+)\s*\(/.test(line)) {
                    return line.replace(/^(\s+)([A-Z][a-z]+)/, '$1<span class="fg-13">$2</span>');
                }
                // Skill lines - white
                else if (/^\s+[\w\s]+:\s*\d+$/.test(line)) {
                    return `<span class="fg-7">${line}</span>`;
                }
                // Stats line - bright green
                else if (/^(SIZE:.*BP:.*DB:.*MD:.*)/.test(line)) {
                    return `<span class="fg-10 bold">${line}</span>`;
                }
                // Weapons/armor/equipment - red
                else if (/^(ARMOR:|WEAPON|WEAPONS:|EQUIPMENT:)/.test(line)) {
                    return `<span class="fg-202 bold">${line}</span>`;
                }
                else {
                    return line;
                }
            });

            return coloredLines.join('\n');
        }

        function makeEncountersClickable(output) {
            // Make encounter lines clickable for detailed NPC view
            // Pattern: "1. Name (Sex, Age) - Type [Level X]"
            const encounterPattern = /(<span[^>]*>)?(\d+)\.\s*([^<]+?)\s*\(([MF]),\s*(\d+)\)\s*-\s*([^[]+)\s*\[Level\s*(\d+)\]/g;

            return output.replace(encounterPattern, (match, spanTag, number, name, sex, age, type, level) => {
                // Clean and escape the parameters to avoid quote issues
                const cleanName = name.trim().replace(/'/g, "\\'").replace(/"/g, '\\"');
                const cleanType = type.trim().replace(/'/g, "\\'").replace(/"/g, '\\"');

                const clickableStyle = 'cursor: pointer; text-decoration: underline; transition: background-color 0.2s;';
                const hoverStyle = 'onmouseover="this.style.backgroundColor=\'#333\'" onmouseout="this.style.backgroundColor=\'transparent\'"';
                const clickHandler = `onclick="showEncounterNPCDetail('${cleanName}', '${sex}', ${age}, '${cleanType}', ${level})"`;

                if (spanTag) {
                    return `${spanTag}${number}. <span style="${clickableStyle}" ${hoverStyle} ${clickHandler}>${name.trim()} (${sex}, ${age}) - ${type.trim()} [Level ${level}]</span>`;
                } else {
                    return `${number}. <span style="${clickableStyle}" ${hoverStyle} ${clickHandler}>${name.trim()} (${sex}, ${age}) - ${type.trim()} [Level ${level}]</span>`;
                }
            });
        }

        async function showEncounterNPCDetail(name, sex, age, type, level) {
            updateStatus('Loading detailed NPC view...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating detailed NPC view...</div>';

            try {
                // Use encounter_npc endpoint to preserve encounter stats
                const params = {
                    name: name,
                    type: type,
                    level: parseInt(level),
                    sex: sex,
                    age: parseInt(age)
                };

                const response = await fetch('/api/encounter_npc/0', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();

                if (result.success) {
                    // Add a back button to return to encounter - positioned left like Generate buttons
                    output.innerHTML = `
                        <button class="btn" onclick="goBackToEncounter()" style="margin: 0 0 10px 0; display: block;">← Back to Encounter</button>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Detailed NPC view loaded');
                } else {
                    output.innerHTML = `<div class="error">Error loading detailed view: ${result.error}</div>`;
                    updateStatus('Error loading detailed view');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
                updateStatus('Network error');
            }
        }

        function goBackToEncounter() {
            // Restore the same encounter list (don't generate new one)
            if (lastEncounterOutput) {
                currentEditContent = lastEncounterOutput;
                const output = document.getElementById('output');
                const clickableOutput = makeEncountersClickable(lastEncounterOutput);
                output.innerHTML = `
                    <button class="edit-btn" onclick="editOutput('encounter', currentEditContent)" style="margin: 0 0 10px 0;">Edit Encounter</button>
                    <div class="output">${clickableOutput}</div>
                `;
                updateStatus('Encounter list restored - Click character names for details');
            } else {
                // Fallback if no stored encounter (shouldn't happen)
                generateEncounter();
            }
        }

        // Store original content for editing
        let currentEditContent = '';

        function editOutput(type, content) {
            // Store content for editing operations
            currentEditContent = content;

            // Convert HTML back to plain text for editing
            const plainText = content.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');

            const output = document.getElementById('output');
            output.innerHTML = `
                <div class="edit-container">
                    <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                        <button class="edit-btn" onclick="saveEdit('${type}')">Save Changes</button>
                        <button class="edit-btn" onclick="cancelEdit('${type}')">Cancel</button>
                    </div>
                    <textarea class="edit-textarea" id="edit-content">${plainText}</textarea>
                </div>
            `;
            updateStatus(`Editing ${type} - Modify text and click Save Changes`);

            // Focus the textarea
            document.getElementById('edit-content').focus();
        }

        function saveEdit(type) {
            const editedContent = document.getElementById('edit-content').value;

            // Convert back to HTML format - but DON'T double-escape HTML entities
            const htmlContent = editedContent.replace(/\n/g, '<br>');

            // Update stored content
            currentEditContent = htmlContent;

            const output = document.getElementById('output');
            output.innerHTML = `
                <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                    <button class="edit-btn" onclick="editOutput('${type}', currentEditContent)">Edit ${type.charAt(0).toUpperCase() + type.slice(1)}</button>
                    <button class="edit-btn" onclick="downloadOutput('${type}', currentEditContent)">Download</button>
                </div>
                <div class="output">${htmlContent}</div>
            `;
            updateStatus(`${type.charAt(0).toUpperCase() + type.slice(1)} edited and saved`);
        }

        function cancelEdit(type) {
            const output = document.getElementById('output');
            output.innerHTML = `
                <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                    <button class="edit-btn" onclick="editOutput('${type}', currentEditContent)">Edit ${type.charAt(0).toUpperCase() + type.slice(1)}</button>
                    <button class="edit-btn" onclick="downloadOutput('${type}', currentEditContent)">Download</button>
                </div>
                <div class="output">${currentEditContent}</div>
            `;
            updateStatus('Edit cancelled - original content restored');
        }

        function downloadOutput(type, content) {
            // Convert HTML to plain text for download
            const plainText = content.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');

            // Create download
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `amar-${type}-${timestamp}.txt`;

            const blob = new Blob([plainText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            updateStatus(`${type.charAt(0).toUpperCase() + type.slice(1)} downloaded as ${filename}`);
        }

        async function generateWeatherPDF() {
            updateStatus('Generating weather PDF...');

            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">Generating weather PDF, please wait...</div>';
            output.style.display = 'block';

            // Hide forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });

            try {
                const response = await fetch('/api/weather_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    currentEditContent = result.output;
                    output.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; gap: 5px; margin: 0 0 5px 0;">
                            <button class="edit-btn" onclick="editOutput('weather-pdf', currentEditContent)">Edit PDF Info</button>
                            <button class="edit-btn" onclick="downloadOutput('weather-pdf', currentEditContent)">Download</button>
                        </div>
                        <div class="output">${result.output}</div>
                    `;
                    updateStatus('Weather PDF LaTeX generated - Edit or Download available');
                } else {
                    output.innerHTML = `<div class="error">Error generating weather PDF: ${result.error}</div>`;
                    updateStatus('Error generating weather PDF');
                }
            } catch (error) {
                output.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
                updateStatus('Network error');
            }
        }

        // Click handlers for menu items and focus switching
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('menu-item') && !e.target.classList.contains('separator') && !e.target.classList.contains('empty')) {
                activateMenuItem(e.target);
            }

            // Switch focus when clicking on panels
            if (e.target.closest('#menuPanel') || e.target.closest('.menu-panel')) {
                if (currentFocus !== 'menu') {
                    currentFocus = 'menu';
                    document.getElementById('menuPanel').classList.add('focused');
                    document.getElementById('contentPanel').classList.remove('focused');
                }
            } else if (e.target.closest('#contentPanel') || e.target.closest('.content-panel')) {
                if (currentFocus !== 'content') {
                    currentFocus = 'content';
                    document.getElementById('menuPanel').classList.remove('focused');
                    document.getElementById('contentPanel').classList.add('focused');
                }
            }
        });
    </script>
</body>
</html>